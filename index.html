<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>WinCE Quiz Dashboard - Supabase</title>

<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.49.4';

  window.supabase = createClient(
    'https://snkqtblebdkhfilqbonw.supabase.co',
    'sb_publishable_kW7wRE5JaUfWCA2yROazgg_H5b82Z56'
  );
</script>

<style>
:root {
    --xp-bg: #c0c0c0;
    --xp-dark: #808080;
    --xp-light: #f0f0f0;
    --xp-blue: #0a246a;
    --xp-accent: #0078d7;
    --xp-border: #404040;
    --xp-text: #000000;
    --danger: #b00020;
    --success: #006400;
}

* { box-sizing: border-box; font-family: Tahoma, "Segoe UI", sans-serif; }
body { margin:0; background: radial-gradient(circle at top left, #e0e0e0, #a0a0a0); color: var(--xp-text); }

.app-shell {
    max-width: 960px;
    margin: 20px auto;
    border: 2px solid var(--xp-border);
    background: var(--xp-bg);
    box-shadow: 0 0 0 1px #fff inset, 0 0 12px rgba(0,0,0,.4);
}

.title-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: linear-gradient(to right, #0a246a, #3a6ea5);
    color: #fff;
    padding: 4px 8px;
    font-size: 12px;
}

.title-left { display: flex; align-items: center; gap: 6px; }
.logo-box { width: 18px; height: 18px; background: linear-gradient(135deg, #0ff, #f0f); border-radius: 3px; border: 1px solid #fff; }
.title-text { font-weight: bold; }

.title-right { display: flex; align-items: center; gap: 8px; font-size: 11px; }
.user-logo { width: 20px; height: 20px; border-radius: 3px; border: 1px solid #fff; background: #444; }

.window-body { padding: 10px; background: linear-gradient(to bottom, #f4f4f4, #c0c0c0); }

.top-status-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #d4d4d4;
    border: 1px solid #fff;
    box-shadow: 0 0 0 1px #808080 inset;
    padding: 4px 8px;
    font-size: 11px;
    margin-bottom: 8px;
    flex-wrap: wrap;
    gap: 10px;
}

.status-group { display: flex; align-items: center; gap: 10px; }
.status-label { font-weight: bold; }

.pill {
    padding: 2px 6px;
    border-radius: 10px;
    border: 1px solid #808080;
    background: #f8f8f8;
    min-width: 60px;
    text-align: center;
}

.pill-balance    { background: linear-gradient(to bottom, #e8ffe8, #b0e0b0); }
.pill-reversal   { background: linear-gradient(to bottom, #ffe8e8, #e0b0b0); }
.pill-logged     { background: linear-gradient(to bottom, #e8f0ff, #b0c4e0); }
.pill-connected  { background: linear-gradient(to bottom, #e8ffe8, #90ee90); color: #006400; }

.content-grid { display: grid; grid-template-columns: 260px 1fr; gap: 10px; }

.panel {
    border: 1px solid #fff;
    box-shadow: 0 0 0 1px #808080 inset;
    background: #dcdcdc;
    padding: 8px;
    font-size: 12px;
}

.panel-title {
    font-weight: bold;
    margin-bottom: 6px;
    padding-bottom: 3px;
    border-bottom: 1px solid #b0b0b0;
}

.field-group { margin-bottom: 6px; }
.field-label { display: block; font-size: 11px; margin-bottom: 2px; }

input[type="text"], input[type="password"] {
    width: 100%;
    padding: 3px 4px;
    border: 1px solid #808080;
    background: #fff;
    font-size: 12px;
}

button {
    padding: 3px 10px;
    font-size: 12px;
    border: 1px solid #404040;
    background: linear-gradient(to bottom, #f8f8f8, #c0c0c0);
    cursor: pointer;
}

button:active { background: linear-gradient(to bottom, #c0c0c0, #f8f8f8); }
button[disabled] { opacity: .5; cursor: default; }

.btn-primary { background: linear-gradient(to bottom, #fff, #d0e4ff); border-color: #0a246a; }
.btn-danger  { background: linear-gradient(to bottom, #ffe0e0, #ffb0b0); border-color: #800000; }

.mini-note { font-size: 10px; color: #333; }
.quiz-questions { margin-top: 6px; }
.quiz-question {
    margin-bottom: 6px;
    padding: 4px;
    border-radius: 3px;
    background: #f4f4f4;
    border: 1px solid #b0b0b0;
}
.quiz-question span { font-weight: bold; }

.info-line { font-size: 11px; margin-top: 4px; }
.reward-info-box {
    margin-top: 6px;
    padding: 4px;
    border-radius: 3px;
    background: #fffbe8;
    border: 1px solid #c0a000;
    font-size: 11px;
}

.footer-bar { margin-top: 8px; font-size: 10px; text-align: right; color: #333; }
.hidden { display: none !important; }

.toast {
    position: fixed;
    bottom: 12px;
    left: 12px;
    background: var(--xp-dark);
    color: #fff;
    padding: 8px 12px;
    border-radius: 0;
    border: 1px solid #fff;
    font-size: 11px;
    box-shadow: 2px 2px 0 rgba(0,0,0,.5);
    opacity: 0;
    pointer-events: none;
    transform: translateY(10px);
    transition: opacity .2s ease, transform .2s ease;
    z-index: 9999;
}
.toast.show { opacity: 1; pointer-events: auto; transform: translateY(0); }

@media (max-width: 720px) {
    .app-shell { margin: 5px; }
    .content-grid { grid-template-columns: 1fr; }
    .toast { left: 50%; transform: translate(-50%,10px); }
    .toast.show { transform: translate(-50%,0); }
}
</style>
</head>
<body>

<div class="app-shell" id="appShell">
    <div class="title-bar">
        <div class="title-left">
            <div class="logo-box"></div>
            <div class="title-text">Quiz Rewards Console - Supabase</div>
        </div>
        <div class="title-right">
            <div id="titleUser" class="mini-user">Guest</div>
            <div id="titleUserLogo" class="user-logo"></div>
        </div>
    </div>

    <div class="window-body">
        <div class="top-status-bar">
            <div class="status-group">
                <span class="status-label">DB:</span>
                <span id="dbStatusPill" class="pill pill-connected">Connecting...</span>
            </div>
            <div class="status-group">
                <span class="status-label">Session:</span>
                <span id="loginStatus" class="pill">Logged out</span>
                <button id="logoutBtn" class="btn-danger hidden">Logout</button>
            </div>
            <div class="status-group">
                <span class="status-label">Balance:</span>
                <span id="balancePill" class="pill pill-balance">0.0 pts</span>
                <span class="status-label">Rev:</span>
                <span id="reversalPill" class="pill pill-reversal">0.0 %</span>
            </div>
        </div>

        <div class="content-grid">
            <div class="panel left-panel">
                <div class="panel-title">Login | Quiz Access</div>

                <div id="loginPanel">
                    <div class="field-group">
                        <label class="field-label" for="userIdInput">UserID</label>
                        <input type="text" id="userIdInput" placeholder="matvei" value="matvei">
                    </div>
                    <div class="field-group">
                        <label class="field-label" for="passIdInput">PassID</label>
                        <input type="password" id="passIdInput" placeholder="••••••" value="matvei">
                    </div>
                    <button id="loginBtn" class="btn-primary">Login</button>
                    <div class="mini-note">Default: matvei / matvei</div>
                </div>

                <div id="quizAccessPanel" class="hidden">
                    <div class="field-group" style="margin-top:12px">
                        <label class="field-label" for="quizIdInput">Quiz Access ID</label>
                        <input type="text" id="quizIdInput" placeholder="matvei01" value="matvei01">
                    </div>
                    <button id="loadQuizBtn" class="btn-primary">Load Quiz</button>
                    <div class="mini-note">Default: matvei01</div>
                </div>

                <div id="bonusSection" class="hidden" style="margin-top:16px;">
                    <div class="panel-title">Bonus Code Redemption</div>
                    <div class="field-group">
                        <input type="text" id="bonusCodeInput" placeholder="Enter bonus code">
                    </div>
                    <button id="redeemBonusBtn" class="btn-primary">Redeem</button>
                </div>
            </div>

            <div class="panel">
                <div class="panel-title">Quiz Dashboard</div>

                <div id="quizPanel" class="hidden">
                    <div id="quizMeta" class="info-line"></div>
                    <div class="quiz-questions" id="quizQuestions"></div>
                    <button id="submitQuizBtn" class="btn-primary" disabled>Submit Answers</button>
                    <div id="quizResult" class="info-line"></div>
                </div>

                <div id="rewardPanel" class="hidden">
                    <div class="info-line">
                        <strong>Reward:</strong> <span id="rewardNameLabel">Quiz Bonus</span><br>
                        <strong>Amount:</strong> <span id="rewardAmountLabel">0</span> pts
                    </div>
                    <button id="claimRewardBtn" class="btn-primary">Claim Reward</button>
                    <div id="rewardInfoBox" class="reward-info-box hidden"></div>
                </div>

                <div id="systemStatus" class="info-line" style="margin-top:12px">
                    <strong>Status:</strong> <span id="systemStatusText">Initializing...</span>
                </div>
            </div>
        </div>

        <div class="footer-bar">
            Supabase Postgres • Reversal % = (1 − (Earned / Total)) × 100
        </div>
    </div>
</div>

<div id="toast" class="toast"></div>

<script>
// ────────────────────────────────────────────────
// MAIN APPLICATION LOGIC (non-module part)
// Uses window.supabase from the type="module" block above
// ────────────────────────────────────────────────

let currentUser = null;
let currentQuiz = null;
let earnedThisSession = 0;
let lifetimeEarned = 0;
let lifetimePossible = 1000;

const els = {
    dbStatusPill: document.getElementById('dbStatusPill'),
    loginStatus: document.getElementById('loginStatus'),
    balancePill: document.getElementById('balancePill'),
    reversalPill: document.getElementById('reversalPill'),
    titleUser: document.getElementById('titleUser'),
    loginBtn: document.getElementById('loginBtn'),
    logoutBtn: document.getElementById('logoutBtn'),
    loadQuizBtn: document.getElementById('loadQuizBtn'),
    submitQuizBtn: document.getElementById('submitQuizBtn'),
    claimRewardBtn: document.getElementById('claimRewardBtn'),
    redeemBonusBtn: document.getElementById('redeemBonusBtn'),
    quizPanel: document.getElementById('quizPanel'),
    rewardPanel: document.getElementById('rewardPanel'),
    quizQuestions: document.getElementById('quizQuestions'),
    quizResult: document.getElementById('quizResult'),
    rewardInfoBox: document.getElementById('rewardInfoBox'),
    systemStatusText: document.getElementById('systemStatusText'),
    bonusSection: document.getElementById('bonusSection'),
    toast: document.getElementById('toast')
};

function showToast(msg, isError = false) {
    els.toast.textContent = msg;
    els.toast.style.background = isError ? "var(--danger)" : "var(--xp-dark)";
    els.toast.classList.add('show');
    setTimeout(() => els.toast.classList.remove('show'), 2800);
}

function updateReversalDisplay() {
    const reversal = lifetimePossible > 0 
        ? ((1 - (lifetimeEarned / lifetimePossible)) * 100).toFixed(1) 
        : 0.0;
    els.reversalPill.textContent = reversal + " %";
}

async function init() {
    try {
        const { data, error } = await window.supabase
            .from('users')
            .select('userid')
            .limit(1);

        if (error) throw error;

        els.dbStatusPill.textContent = "Live (Supabase)";
        els.systemStatusText.textContent = "Connected to Supabase";
        showToast("Database connected");
    } catch (err) {
        console.error("Supabase connection failed:", err);
        els.dbStatusPill.textContent = "Error";
        els.dbStatusPill.className = "pill";
        els.systemStatusText.textContent = "Connection failed - check console";
        showToast("Cannot connect to database", true);
    }
}

function setLoggedIn(user) {
    currentUser = user;
    els.titleUser.textContent = user.userid;
    els.loginStatus.textContent = "Logged in";
    els.loginStatus.className = "pill pill-logged";
    els.balancePill.textContent = Number(user.balance||0).toFixed(1) + " pts";
    document.getElementById('loginPanel').classList.add('hidden');
    document.getElementById('quizAccessPanel').classList.remove('hidden');
    els.logoutBtn.classList.remove('hidden');
    els.bonusSection.classList.remove('hidden');
    updateReversalDisplay();
}

function setLoggedOut() {
    currentUser = null;
    currentQuiz = null;
    earnedThisSession = 0;
    els.titleUser.textContent = "Guest";
    els.loginStatus.textContent = "Logged out";
    els.loginStatus.className = "pill";
    els.balancePill.textContent = "0.0 pts";
    els.reversalPill.textContent = "0.0 %";
    els.logoutBtn.classList.add('hidden');
    document.getElementById('loginPanel').classList.remove('hidden');
    document.getElementById('quizAccessPanel').classList.add('hidden');
    els.bonusSection.classList.add('hidden');
    els.quizPanel.classList.add('hidden');
    els.rewardPanel.classList.add('hidden');
}

els.loginBtn.onclick = async () => {
    const uid = document.getElementById('userIdInput').value.trim();
    const pwd = document.getElementById('passIdInput').value;

    if (!uid || !pwd) return showToast("Enter username and password", true);

    try {
        const { data, error } = await window.supabase
            .from('users')
            .select('*')
            .eq('userid', uid)
            .eq('passid', pwd)
            .single();

        if (error || !data) return showToast("Invalid credentials", true);

        setLoggedIn(data);
        showToast("Welcome back!");
    } catch (err) {
        showToast("Login error", true);
        console.error(err);
    }
};

els.logoutBtn.onclick = () => {
    setLoggedOut();
    showToast("Logged out");
};

els.loadQuizBtn.onclick = async () => {
    const code = document.getElementById('quizIdInput').value.trim();
    if (!code) return showToast("Enter quiz ID", true);

    try {
        const { data, error } = await window.supabase
            .from('quizzes')
            .select('*')
            .eq('quiz_access_id', code)
            .single();

        if (error || !data) return showToast("Quiz not found", true);

        currentQuiz = data;

        document.getElementById('quizMeta').textContent = 
            `Quiz: ${data.title || data.quiz_access_id} • Reward: ${data.reward} pts`;

        const container = els.quizQuestions;
        container.innerHTML = '';

        for (let i = 1; i <= 3; i++) {
            const q = data[`q${i}`];
            if (!q) continue;
            const div = document.createElement('div');
            div.className = 'quiz-question';
            div.innerHTML = `
                <span>Q${i}:</span> ${q}<br>
                <input type="text" class="quiz-input" data-index="${i}" placeholder="Your answer...">
            `;
            container.appendChild(div);
        }

        els.quizPanel.classList.remove('hidden');
        els.submitQuizBtn.disabled = false;
        els.rewardPanel.classList.add('hidden');
        showToast("Quiz loaded");
    } catch (err) {
        showToast("Error loading quiz", true);
        console.error(err);
    }
};

els.submitQuizBtn.onclick = async () => {
    if (!currentQuiz) return;

    const inputs = document.querySelectorAll('.quiz-input');
    let correct = 0;
    let answered = 0;

    inputs.forEach(inp => {
        const idx = inp.dataset.index;
        const expected = (currentQuiz[`a${idx}`] || '').trim().toLowerCase();
        const given = inp.value.trim().toLowerCase();
        if (given) {
            answered++;
            if (given === expected) correct++;
        }
    });

    const score = answered > 0 ? (correct / answered) : 0;
    earnedThisSession = Math.round(score * currentQuiz.reward);

    els.quizResult.innerHTML = `
        Correct: ${correct}/${answered} • Score: ${(score*100).toFixed(0)}%<br>
        You earned: ${earnedThisSession} pts
    `;

    if (earnedThisSession > 0) {
        els.rewardAmountLabel.textContent = earnedThisSession;
        els.rewardPanel.classList.remove('hidden');
    }

    showToast(`You earned ${earnedThisSession} pts`);
};

els.claimRewardBtn.onclick = async () => {
    if (!currentUser || earnedThisSession <= 0) return showToast("No reward to claim", true);

    try {
        const newBalance = Number(currentUser.balance || 0) + earnedThisSession;

        const { error } = await window.supabase
            .from('users')
            .update({ balance: newBalance })
            .eq('userid', currentUser.userid);

        if (error) throw error;

        lifetimeEarned += earnedThisSession;
        currentUser.balance = newBalance;

        els.balancePill.textContent = newBalance.toFixed(1) + " pts";
        updateReversalDisplay();

        els.rewardInfoBox.textContent = "Reward claimed successfully!";
        els.rewardInfoBox.classList.remove('hidden');
        showToast("Reward added to balance");

        earnedThisSession = 0;
        els.rewardPanel.classList.add('hidden');
    } catch (err) {
        showToast("Error claiming reward", true);
        console.error(err);
    }
};

els.redeemBonusBtn.onclick = async () => {
    if (!currentUser) return showToast("Please login first", true);

    const code = document.getElementById('bonusCodeInput').value.trim().toUpperCase();
    if (!code) return showToast("Enter code", true);

    try {
        const { data: bonus, error: fetchErr } = await window.supabase
            .from('bonus_codes')
            .select('*')
            .eq('code', code)
            .is('used_by', null)
            .single();

        if (fetchErr || !bonus) return showToast("Invalid or already used code", true);

        const newBalance = Number(currentUser.balance || 0) + Number(bonus.points);

        // Update bonus code
        await window.supabase
            .from('bonus_codes')
            .update({ 
                used_by: currentUser.userid, 
                used_at: new Date().toISOString() 
            })
            .eq('code', code);

        // Update user balance
        await window.supabase
            .from('users')
            .update({ balance: newBalance })
            .eq('userid', currentUser.userid);

        currentUser.balance = newBalance;
        els.balancePill.textContent = newBalance.toFixed(1) + " pts";

        showToast(`Success! +${bonus.points} pts from code ${code}`);
    } catch (err) {
        showToast("Error redeeming code", true);
        console.error(err);
    }
};

// Start the app
init();
</script>
</body>
</html>
