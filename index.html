<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>IML Console</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
/* ================= CONFIG ================= */
var CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTbr8c2K0uVJEeMCxCxd8bm9cUUE1ppa_wAWSEuxAti6kZRSH6vhgN54r-oqwbr9j46r5RTIKne8kqk/pub?output=csv";
var SUBMIT_URL = "https://script.google.com/macros/s/AKfycbzGE7BtUsUceMeoFA6_hDKBU21ChxA9Gd0_XMkt_CQZ8amWGRDGGFCmKW2bNWTpR2bP/exec";

var BASE_RATE = 10;
var POINTS_PER_CORRECT = 5;
var REVERSAL_THRESHOLD = 3;
var HOLD_DAYS = 15;

/* ================= STATE ================= */
var state = {
  rows: [],
  user: null,
  pts: 0,
  reversal: 0,
  correct: 0,
  attempts: 0,
  csvLoaded: false
};
var refs = {};

/* ================= HELPERS ================= */
function el(t, c, txt) {
  var e = document.createElement(t);
  if (c) e.className = c;
  if (txt !== undefined) e.textContent = txt;
  return e;
}

/* ================= ASSETS ================= */
(function inject(){
  document.head.insertAdjacentHTML("beforeend",`
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&display=swap">
<style>
body{background:#0b1a33;color:#fff;font-family:Ubuntu;margin:0}
.iml-page{display:none}
.iml-page.active{display:block}
.iml-input{background:#020617;color:#fff;border:1px solid #334}
.btn-iml{background:#667eea;color:#fff;border:none}
.panel-iml{background:#111827;border-radius:8px}
.iml-status-chip{padding:4px 10px;border-radius:20px;background:#22c55e}
.inactive{background:#ef4444}
.iml-stat-val{font-size:22px;font-weight:700}
</style>`);
})();

/* ================= CSV ================= */
function parseCSV(text){
  var lines=text.trim().split("\n");
  var headers=lines[0].split(",");
  var rows=[];
  for(let i=1;i<lines.length;i++){
    if(!lines[i])continue;
    let vals=lines[i].split(",");
    let o={};
    headers.forEach((h,j)=>o[h.trim()]=vals[j]?.trim()||"");
    rows.push(o);
  }
  return rows;
}

function fetchCSV(){
  fetch(CSV_URL).then(r=>r.text()).then(t=>{
    state.rows=parseCSV(t);
    state.csvLoaded=true;
    refs.loginBtn.disabled=false;
    refs.loginBtn.textContent="Login";
    refs.dbStatus.textContent="Database connected ✓";
  }).catch(()=>{
    refs.dbStatus.textContent="Database failed ✖";
  });
}

/* ================= LOGIN ================= */
function findUser(u,p){
  u=u.toLowerCase();
  for(let r of state.rows){
    if((r.Username||"").toLowerCase()===u && r.Password===p){
      return {
        username:r.Username,
        status:r.Status||"Inactive",
        pts:+r.PTS||0,
        reversal:+r.Reversal||0,
        q1:r["#1"], q2:r["#2"], q3:r["#3"],
        a1:r.Ans1, a2:r.Ans2, a3:r.Ans3
      };
    }
  }
  return null;
}

function onLogin(){
  var u=document.getElementById("username").value;
  var p=document.getElementById("password").value;
  var user=findUser(u,p);
  if(!user){alert("Invalid login");return;}
  state.user=user;
  state.pts=user.pts;
  refs.loginPanel.style.display="none";
  refs.dashPanel.style.display="block";
  refs.statusChip.textContent=user.status;
  refs.qBlocks[0].text.textContent=user.q1;
  refs.qBlocks[1].text.textContent=user.q2;
  refs.qBlocks[2].text.textContent=user.q3;
  updateStats();
}

/* ================= QUIZ ================= */
function submitAnswer(i){
  var q=refs.qBlocks[i];
  var correct=[state.user.a1,state.user.a2,state.user.a3][i];
  state.attempts++;
  if(q.input.value.trim()===correct){
    state.correct++;
    state.pts+=POINTS_PER_CORRECT;
    q.input.disabled=true;
    q.button.disabled=true;
  }
  state.reversal = state.attempts
    ? ((state.attempts-state.correct)/state.attempts)*100
    : 0;
  updateStats();
}

function updateStats(){
  refs.stat_pts.textContent=state.pts.toFixed(2);
  refs.stat_rev.textContent=state.reversal.toFixed(2)+"%";
}

/* ================= UI ================= */
function build(){
document.body.innerHTML=`
<div class="container">
<div class="panel panel-iml" id="loginPanel">
<div class="panel-body">
<div id="dbStatus">Connecting…</div>
<input id="username" class="form-control iml-input" placeholder="Username"><br>
<input id="password" type="password" class="form-control iml-input" placeholder="Password"><br>
<button id="loginBtn" class="btn btn-iml btn-block" disabled>Loading DB…</button>
</div></div>

<div class="panel panel-iml" id="dashPanel" style="display:none">
<div class="panel-body">
<span>Status: <span class="iml-status-chip" id="statusChip"></span></span>
<hr>
<div>PTS: <span id="stat_pts">0</span></div>
<div>Reversal: <span id="stat_rev">0%</span></div>
<hr>
<div id="q1"></div>
<div id="q2"></div>
<div id="q3"></div>
</div></div>
</div>`;

refs.loginPanel=document.getElementById("loginPanel");
refs.dashPanel=document.getElementById("dashPanel");
refs.loginBtn=document.getElementById("loginBtn");
refs.dbStatus=document.getElementById("dbStatus");
refs.statusChip=document.getElementById("statusChip");
refs.stat_pts=document.getElementById("stat_pts");
refs.stat_rev=document.getElementById("stat_rev");

refs.qBlocks=[0,1,2].map(i=>{
  var d=el("div");
  var t=el("div");
  var inp=el("input","form-control iml-input");
  var b=el("button","btn btn-iml","Submit");
  b.onclick=()=>submitAnswer(i);
  d.append(t,inp,b);
  document.getElementById("q"+(i+1)).appendChild(d);
  return {text:t,input:inp,button:b};
});

refs.loginBtn.onclick=onLogin;
fetchCSV();
}

window.onload=build;
</script>
</head>
<body></body>
</html>
