<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Quiz Rewards Console</title>

<style>
:root {
    --win-bg:        #c0c0c0;
    --win-dark:      #808080;
    --win-light:     #f0f0f0;
    --win-blue:      #000080;
    --win-blue-light:#1084d0;
    --win-border:    #404040;
    --win-text:      #000000;
    --pill-green:    #d0ffd0;
    --pill-red:      #ffd0d0;
    --pill-blue:     #d0e0ff;
    --danger:        #a04040;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
    font-family: Tahoma, Arial, sans-serif;
    background: #008080;
    color: var(--win-text);
    min-height: 100vh;
    font-size: 13px;
    line-height: 1.4;
    -webkit-tap-highlight-color: transparent;
}

.container {
    max-width: 420px;
    margin: 0 auto;
    background: var(--win-bg);
    border: 2px solid var(--win-dark);
    box-shadow: 0 0 0 1px #fff inset, 3px 3px 8px rgba(0,0,0,0.5);
}

.title-bar {
    background: linear-gradient(to right, #000080, #1084d0);
    color: white;
    padding: 6px 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
    font-size: 13px;
}

.title-left { display: flex; align-items: center; gap: 8px; }

.logo {
    width: 20px;
    height: 20px;
    background: linear-gradient(135deg, cyan, magenta);
    border: 1px solid white;
    border-radius: 2px;
}

.status-bar {
    background: #c0c0c0;
    border-bottom: 1px solid #808080;
    padding: 6px 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    font-size: 12px;
}

.status-pill {
    padding: 2px 8px;
    border-radius: 10px;
    border: 1px solid #808080;
    background: #e0e0e0;
    min-width: 70px;
    text-align: center;
    font-weight: bold;
}

.pill-logged   { background: var(--pill-blue);   color: #000080; }
.pill-balance  { background: var(--pill-green);  color: #006400; }
.pill-reversal { background: var(--pill-red);    color: #800000; }

.main-panel {
    padding: 10px;
    background: linear-gradient(to bottom, #f0f0f0, #d8d8d8);
}

.section-title {
    font-weight: bold;
    font-size: 14px;
    margin-bottom: 8px;
    padding-bottom: 4px;
    border-bottom: 1px solid #808080;
    color: #000080;
}

.field-row { margin-bottom: 12px; }

.field-label {
    font-size: 12px;
    margin-bottom: 3px;
    display: block;
    font-weight: bold;
}

input[type="text"],
input[type="password"] {
    width: 100%;
    padding: 8px 10px;
    font-size: 15px;
    border: 2px inset #ffffff;
    background: white;
    font-family: Tahoma, sans-serif;
}

button {
    width: 100%;
    padding: 10px;
    margin: 8px 0;
    font-size: 15px;
    font-weight: bold;
    border: 2px outset #c0c0c0;
    background: linear-gradient(to bottom, #f0f0f0, #c0c0c0);
    cursor: pointer;
}

button:active {
    border-style: inset;
    background: linear-gradient(to bottom, #c0c0c0, #f0f0f0);
}

.btn-primary {
    background: linear-gradient(to bottom, #d0e8ff, #a0c8ff);
    border-color: #000080;
}

.mini-note {
    font-size: 11px;
    color: #404040;
    margin-top: 4px;
}

.quiz-item {
    background: #e8e8e8;
    border: 1px solid #909090;
    padding: 10px;
    margin: 10px 0;
    border-radius: 4px;
}

.info {
    font-size: 13px;
    margin: 10px 0;
    color: #000;
}

.reward-box {
    background: #ffffe0;
    border: 2px solid #c0a040;
    padding: 12px;
    margin: 12px 0;
    border-radius: 4px;
}

.footer {
    text-align: center;
    font-size: 11px;
    color: #404040;
    padding: 10px;
    border-top: 1px solid #909090;
    background: #d0d0d0;
}

#toast {
    position: fixed;
    bottom: 16px;
    left: 12px;
    right: 12px;
    background: rgba(0,0,0,0.85);
    color: white;
    padding: 12px 16px;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.6);
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.25s ease;
    z-index: 1000;
    text-align: center;
    font-size: 14px;
}

#toast.show {
    opacity: 1;
    transform: translateY(0);
}

.hidden { display: none !important; }
</style>
</head>
<body>

<div class="container">

    <div class="title-bar">
        <div class="title-left">
            <div class="logo"></div>
            <div>Quiz Rewards Console</div>
        </div>
        <div id="titleUser">Guest</div>
    </div>

    <div class="status-bar">
        <div class="status-pill pill-logged" id="sessionPill">Logged out</div>
        <div class="status-pill pill-balance" id="balancePill">0.0 pts</div>
        <div class="status-pill pill-reversal" id="reversalPill">0.0 %</div>
    </div>

    <div class="main-panel">

        <div id="loginSection">
            <div class="section-title">Login / Quiz Access</div>
            
            <div class="field-row">
                <div class="field-label">UserID</div>
                <input type="text" id="userIdInput" value="matvei" autocomplete="off">
            </div>

            <div class="field-row">
                <div class="field-label">PassID</div>
                <input type="password" id="passIdInput" value="matvei">
            </div>

            <button class="btn-primary" id="loginBtn">Login</button>
            <div class="mini-note">Default: matvei / matvei</div>
        </div>

        <div id="quizAccessSection" class="hidden">
            <div class="section-title">Quiz Access</div>
            <div class="field-row">
                <div class="field-label">Quiz ID</div>
                <input type="text" id="quizIdInput" value="matvei01">
            </div>
            <button id="loadQuizBtn">Load Quiz</button>
        </div>

        <div id="bonusSection" class="hidden">
            <div class="section-title">Bonus Code</div>
            <div class="field-row">
                <input type="text" id="bonusCodeInput" placeholder="Enter code" style="text-transform:uppercase;">
            </div>
            <button id="redeemBonusBtn">Redeem</button>
        </div>

        <div id="quizSection" class="hidden">
            <div class="section-title">Quiz</div>
            <div id="quizMeta" class="info"></div>
            <div id="quizQuestions"></div>
            <button id="submitQuizBtn" disabled>Submit Quiz</button>
            <div id="quizResult" class="info"></div>
        </div>

        <div id="rewardSection" class="hidden">
            <div class="section-title">Reward</div>
            <div class="info">
                Amount: <strong><span id="rewardAmount">0</span> pts</strong>
            </div>
            <button id="claimRewardBtn">Claim</button>
            <div id="rewardMessage" class="reward-box hidden"></div>
        </div>

        <div class="info">
            <strong>Status:</strong> <span id="statusText">Waiting...</span>
        </div>

    </div>

    <div class="footer">
        Reversal % = (1 - (Earned / Total)) × 100
    </div>

</div>

<div id="toast"></div>

<script>
// ────────────────────────────────────────────────
// Your Google Apps Script URL
const API_URL = 'https://script.google.com/macros/s/AKfycbzfuU5kqyTwmO-TKNnw4UWn0AALKPAHa78dUQWh5XwPRZaOhI_CDrWyUMx2Et6yxhDF/exec';

let currentUser = null;
let currentQuiz = null;
let earnedThisSession = 0;
let quizAnswers = {};

const els = {
    titleUser      : document.getElementById('titleUser'),
    sessionPill    : document.getElementById('sessionPill'),
    balancePill    : document.getElementById('balancePill'),
    reversalPill   : document.getElementById('reversalPill'),
    statusText     : document.getElementById('statusText'),
    loginBtn       : document.getElementById('loginBtn'),
    loadQuizBtn    : document.getElementById('loadQuizBtn'),
    submitQuizBtn  : document.getElementById('submitQuizBtn'),
    claimRewardBtn : document.getElementById('claimRewardBtn'),
    redeemBonusBtn : document.getElementById('redeemBonusBtn'),
    quizQuestions  : document.getElementById('quizQuestions'),
    quizMeta       : document.getElementById('quizMeta'),
    quizResult     : document.getElementById('quizResult'),
    rewardAmount   : document.getElementById('rewardAmount'),
    rewardMessage  : document.getElementById('rewardMessage'),
    toast          : document.getElementById('toast')
};

function showToast(msg, error = false) {
    els.toast.textContent = msg;
    els.toast.style.background = error ? '#800000' : '#004080';
    els.toast.classList.add('show');
    setTimeout(() => els.toast.classList.remove('show'), 2800);
}

function updateReversal(earned = 0, total = 1000) {
    const perc = total > 0 ? Math.max(0, ((1 - earned/total)*100)).toFixed(1) : 0;
    els.reversalPill.textContent = perc + " %";
    
    // Update pill color based on percentage
    const reversalValue = parseFloat(perc);
    if (reversalValue >= 50) {
        els.reversalPill.className = "status-pill pill-reversal";
    } else if (reversalValue > 0) {
        els.reversalPill.className = "status-pill pill-blue";
    } else {
        els.reversalPill.className = "status-pill pill-green";
    }
}

async function apiCall(action, payload = {}) {
    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            redirect: 'follow',
            headers: {
                'Content-Type': 'text/plain;charset=utf-8'
            },
            body: JSON.stringify({ action, ...payload })
        });

        if (!response.ok) {
            const text = await response.text();
            console.error("API Error Response:", text);
            throw new Error(`HTTP ${response.status}: ${text.substring(0, 100)}`);
        }

        const data = await response.json();
        console.log(`API ${action} response:`, data);
        return data;
    } catch (e) {
        console.error("API Call Error:", e);
        showToast("Connection failed: " + (e.message || "Unknown error"), true);
        return { success: false, message: e.message };
    }
}

// ─── Login ──────────────────────────────────────────────
els.loginBtn.addEventListener('click', async () => {
    const uid = document.getElementById('userIdInput').value.trim();
    const pwd = document.getElementById('passIdInput').value.trim();
    if (!uid || !pwd) return showToast("Enter UserID and PassID", true);

    els.statusText.textContent = "Logging in...";
    const r = await apiCall('login', { userid: uid, passid: pwd });
    
    if (r.success) {
        currentUser = r.user;
        els.titleUser.textContent = r.user.userid;
        els.sessionPill.textContent = "Logged in";
        els.sessionPill.className = "status-pill pill-logged";
        els.balancePill.textContent = Number(r.user.balance || 0).toFixed(1) + " pts";
        
        // Make sure lifetime_possible has a reasonable default
        const lifetimeEarned = Number(r.user.lifetime_earned || 0);
        const lifetimePossible = Number(r.user.lifetime_possible || 1000);
        updateReversal(lifetimeEarned, lifetimePossible);

        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('quizAccessSection').classList.remove('hidden');
        document.getElementById('bonusSection').classList.remove('hidden');
        showToast("Logged in successfully");
        els.statusText.textContent = "Ready to load quiz";
    } else {
        showToast(r.message || "Login failed", true);
        els.statusText.textContent = "Login failed";
    }
});

// ─── Load Quiz ──────────────────────────────────────────
els.loadQuizBtn.addEventListener('click', async () => {
    const code = document.getElementById('quizIdInput').value.trim();
    if (!code) return showToast("Enter quiz ID", true);

    els.statusText.textContent = "Loading quiz...";
    const r = await apiCall('getQuiz', { quiz_access_id: code });
    
    if (!r.success) {
        showToast(r.message || "Quiz not found", true);
        els.statusText.textContent = "Quiz load failed";
        return;
    }

    currentQuiz = r.quiz;
    console.log("Loaded quiz:", currentQuiz);
    
    // Check if quiz has questions and answers
    if (!currentQuiz.q1 && !currentQuiz.q2 && !currentQuiz.q3) {
        showToast("Quiz has no questions", true);
        return;
    }

    els.quizMeta.innerHTML = `<strong>Reward:</strong> ${r.quiz.reward || 0} pts<br>
                             <strong>Questions:</strong> 3`;

    let html = '';
    for (let i = 1; i <= 3; i++) {
        const q = r.quiz[`q${i}`];
        const a = r.quiz[`a${i}`] || '';
        
        if (q) {
            html += `
            <div class="quiz-item">
                <div><strong>Question ${i}</strong></div>
                <div style="margin: 6px 0;">${q}</div>
                <input type="text" class="quiz-input" data-q="${i}" 
                       placeholder="Your answer..." 
                       style="margin-top:6px;width:100%;padding:8px;">
                <div style="font-size:11px;color:#666;margin-top:4px;display:none;" 
                     class="correct-answer" data-q="${i}">
                     Correct: ${a}
                </div>
            </div>`;
        }
    }
    
    els.quizQuestions.innerHTML = html;
    document.getElementById('quizSection').classList.remove('hidden');
    els.submitQuizBtn.disabled = false;
    
    showToast("Quiz loaded successfully");
    els.statusText.textContent = "Answer questions and submit";
});

// ─── Submit Quiz ────────────────────────────────────────
els.submitQuizBtn.addEventListener('click', () => {
    if (!currentQuiz) {
        showToast("No quiz loaded", true);
        return;
    }

    const inputs = document.querySelectorAll('.quiz-input');
    let correct = 0, answered = 0, total = 0;

    // Show all correct answers (for debugging)
    document.querySelectorAll('.correct-answer').forEach(el => {
        el.style.display = 'block';
    });

    inputs.forEach(el => {
        const idx = el.dataset.q;
        const expected = (currentQuiz[`a${idx}`] || '').trim().toLowerCase();
        const val = el.value.trim().toLowerCase();
        
        if (expected) total++; // Count total questions that have answers
        
        if (val) {
            answered++;
            if (val === expected) {
                correct++;
                el.style.border = '2px solid #00aa00';
            } else {
                el.style.border = '2px solid #aa0000';
            }
        } else {
            el.style.border = '2px solid #ffaa00';
        }
    });

    console.log(`Quiz results: ${correct} correct, ${answered} answered, ${total} total questions`);

    const score = total > 0 ? correct / total : 0;
    earnedThisSession = Math.round(score * (currentQuiz.reward || 0));

    els.quizResult.innerHTML = `
        <strong>Results:</strong><br>
        Correct: ${correct}/${total}<br>
        Score: ${Math.round(score * 100)}%<br>
        <strong>Earned: +${earnedThisSession} pts</strong>`;

    if (earnedThisSession > 0) {
        els.rewardAmount.textContent = earnedThisSession;
        document.getElementById('rewardSection').classList.remove('hidden');
        els.statusText.textContent = `Ready to claim ${earnedThisSession} pts`;
    } else {
        showToast("No points earned", true);
        els.statusText.textContent = "No points earned";
    }
    
    showToast(`Earned ${earnedThisSession} pts`);
});

// ─── Claim Reward ───────────────────────────────────────
els.claimRewardBtn.addEventListener('click', async () => {
    if (earnedThisSession <= 0) {
        showToast("No reward to claim", true);
        return;
    }

    if (!currentUser) {
        showToast("Not logged in", true);
        return;
    }

    els.statusText.textContent = "Claiming reward...";
    const r = await apiCall('claimReward', {
        userid: currentUser.userid,
        amount: earnedThisSession
    });
    
    console.log("Claim reward response:", r);
    
    if (r.success) {
        // Update user data from response
        if (r.user) {
            currentUser.balance = r.user.balance || currentUser.balance;
            currentUser.lifetime_earned = r.user.lifetime_earned || currentUser.lifetime_earned;
            currentUser.lifetime_possible = r.user.lifetime_possible || currentUser.lifetime_possible;
        } else {
            currentUser.balance = r.newBalance || currentUser.balance;
            currentUser.lifetime_earned = r.newEarned || currentUser.lifetime_earned;
        }

        els.balancePill.textContent = Number(currentUser.balance).toFixed(1) + " pts";
        
        // Update reversal with current values
        const lifetimeEarned = Number(currentUser.lifetime_earned || 0);
        const lifetimePossible = Number(currentUser.lifetime_possible || 1000);
        updateReversal(lifetimeEarned, lifetimePossible);

        els.rewardMessage.textContent = `Success! +${earnedThisSession} pts added to your balance.`;
        els.rewardMessage.classList.remove('hidden');
        
        showToast(`Reward of ${earnedThisSession} pts claimed!`);
        els.statusText.textContent = "Reward claimed successfully";

        // Reset for next quiz
        earnedThisSession = 0;
        setTimeout(() => {
            document.getElementById('rewardSection').classList.add('hidden');
            els.rewardMessage.classList.add('hidden');
        }, 3000);
    } else {
        showToast(r.message || "Claim failed", true);
        els.statusText.textContent = "Claim failed";
    }
});

// ─── Redeem Bonus ───────────────────────────────────────
els.redeemBonusBtn.addEventListener('click', async () => {
    if (!currentUser) {
        showToast("Please login first", true);
        return;
    }

    const code = document.getElementById('bonusCodeInput').value.trim().toUpperCase();
    if (!code) return showToast("Enter bonus code", true);

    els.statusText.textContent = "Redeeming bonus...";
    const r = await apiCall('redeemBonus', { 
        userid: currentUser.userid, 
        code: code 
    });
    
    console.log("Redeem bonus response:", r);
    
    if (r.success) {
        // Update user balance
        currentUser.balance = r.newBalance || (currentUser.balance + (r.pointsAdded || 0));
        els.balancePill.textContent = Number(currentUser.balance).toFixed(1) + " pts";
        
        // Update reversal if lifetime earned changed
        if (r.newEarned !== undefined) {
            currentUser.lifetime_earned = r.newEarned;
            const lifetimeEarned = Number(currentUser.lifetime_earned || 0);
            const lifetimePossible = Number(currentUser.lifetime_possible || 1000);
            updateReversal(lifetimeEarned, lifetimePossible);
        }
        
        showToast(`Bonus redeemed! +${r.pointsAdded || 0} pts added`);
        els.statusText.textContent = "Bonus redeemed successfully";
        
        // Clear input
        document.getElementById('bonusCodeInput').value = '';
    } else {
        showToast(r.message || "Cannot redeem bonus code", true);
        els.statusText.textContent = "Bonus redemption failed";
    }
});

// Add input event listeners to enable/disable buttons
document.addEventListener('DOMContentLoaded', () => {
    // Enable submit button when any quiz answer is entered
    document.addEventListener('input', (e) => {
        if (e.target.classList.contains('quiz-input')) {
            els.submitQuizBtn.disabled = false;
        }
    });
});

// Initialize
els.statusText.textContent = "Enter credentials and login";
console.log("Quiz Rewards Console initialized");
</script>
</body>
</html>
