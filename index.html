<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>IML Terminal</title>

<style>
html,body{margin:0;height:100%;background:#111;font-family:Tahoma;color:#0f0}
#device{width:480px;height:800px;margin:auto;border:3px solid #666;background:#000}
.panel{border:2px inset #555;padding:10px;margin-top:10px}
input,button,select{width:100%;padding:10px;font-size:16px;margin-top:5px;background:#000;color:#0f0;border:1px solid #555}
button{background:#063;color:#fff;cursor:pointer}
.hidden{display:none}
</style>
</head>

<body>
<div id="device">
  <div class="panel" id="loginBox">
    <input id="uid" placeholder="UserID">
    <input id="pid" type="password" placeholder="PassID">
    <button onclick="login()">LOGIN</button>
  </div>

  <div class="panel hidden" id="infoBox">
    Status: <span id="status"></span><br>
    PTS: <span id="pts"></span><br>
    Reversal: <span id="rev"></span>
  </div>

  <div class="panel hidden" id="quizBox">
    <div id="q"></div>
    <input id="a" placeholder="Answer">
    <button onclick="submitQuiz()">SUBMIT</button>
  </div>

  <div class="panel hidden" id="rewardBox">
    <select id="rewardList"></select>
    <button onclick="redeem()">REDEEM</button>
    <div id="rewardInfo"></div>
  </div>
</div>

<script>
const URL = "YOUR_WEB_APP_URL";
let user, correct;

function csv(t){return t.trim().split(/\n/).map(r=>r.split(","));}

async function login(){
  const r = await fetch(URL);
  const rows = csv(await r.text()); rows.shift();
  user = rows.find(x=>x[0]==uid.value && x[1]==pid.value);
  if(!user||user[2]=="BLOCKED") return alert("DENIED");

  status.textContent=user[2];
  pts.textContent=user[3];
  rev.textContent=user[4]+"%";
  q.textContent=user[5];
  correct=user[6];

  loginBox.classList.add("hidden");
  infoBox.classList.remove("hidden");
  quizBox.classList.remove("hidden");
  loadRewards();
}

async function submitQuiz(){
  const ok = a.value.trim()===correct;
  const body =
    "uid="+user[0]+
    "&correct="+(ok?1:0);

  const r = await fetch(URL,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body});
  const j = await r.json();

  status.textContent=j.status;
  pts.textContent=j.pts;
  rev.textContent=j.reversal+"%";
  quizBox.classList.add("hidden");
}

async function loadRewards(){
  const r = await fetch(URL+"?rewards=1");
  const rows = csv(await r.text()); rows.shift();
  rewardList.innerHTML="";
  rows.forEach((x,i)=>{
    const o=document.createElement("option");
    o.value=i;
    o.text=x[1]+" - "+x[2]+" PTS";
    rewardList.appendChild(o);
  });
  rewardBox.classList.remove("hidden");
}

async function redeem(){
  if(Number(rev.textContent)>=1) return alert("Reversal too high");
  const idx = rewardList.value;
  const body="uid="+user[0]+"&reward="+idx;
  await fetch(URL,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body});
  alert("Redeem Requested");
}
</script>
</body>
</html>
