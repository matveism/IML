<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quiz Rewards Console</title>
<style>
  :root {
    --xp-bg: #c0c0c0;
    --xp-dark: #808080;
    --xp-light: #f0f0f0;
    --xp-blue: #0a246a;
    --xp-accent: #0078d7;
    --xp-border: #404040;
    --xp-text: #000000;
    --danger: #b00020;
    --success: #0a7c00;
    --warning: #c0a000;
  }
  * { box-sizing: border-box; font-family: "Tahoma", "Segoe UI", sans-serif; }
  body {
    margin: 0;
    background: radial-gradient(circle at top left, #e0e0e0, #a0a0a0);
    color: var(--xp-text);
    min-height: 100vh;
  }
  .app-shell {
    max-width: 1200px;
    margin: 20px auto;
    border: 2px solid var(--xp-border);
    background: var(--xp-bg);
    box-shadow: 0 0 0 1px #ffffff inset, 0 0 12px rgba(0,0,0,0.4);
  }
  .title-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: linear-gradient(to right, #0a246a, #3a6ea5);
    color: #ffffff;
    padding: 4px 8px;
    font-size: 12px;
  }
  .title-left { display: flex; align-items: center; gap: 6px; }
  .logo-box {
    width: 18px; height: 18px;
    background: linear-gradient(135deg, #00ffff, #ff00ff);
    border-radius: 3px; border: 1px solid #ffffff;
  }
  .title-text { font-weight: bold; }
  .title-right { display: flex; align-items: center; gap: 8px; font-size: 11px; }
  .user-logo {
    width: 20px; height: 20px; border-radius: 3px;
    border: 1px solid #ffffff; background-size: cover;
    background-position: center; background-color: #444;
  }
  .hamburger { display: none; width: 20px; height: 16px; flex-direction: column; justify-content: space-between; cursor: pointer; }
  .hamburger span { display: block; height: 3px; background: #ffffff; border-radius: 2px; }
  .window-body { padding: 10px; background: linear-gradient(to bottom, #f4f4f4, #c0c0c0); }
  .top-status-bar {
    display: flex; justify-content: space-between; align-items: center;
    background: #d4d4d4; border: 1px solid #ffffff;
    box-shadow: 0 0 0 1px #808080 inset; padding: 4px 8px; font-size: 11px; margin-bottom: 8px;
  }
  .status-group { display: flex; align-items: center; gap: 10px; }
  .status-label { font-weight: bold; }
  .pill {
    padding: 2px 6px; border-radius: 10px; border: 1px solid #808080;
    background: #f8f8f8; min-width: 60px; text-align: center;
  }
  .pill-balance { background: linear-gradient(to bottom, #e8ffe8, #b0e0b0); }
  .pill-reversal { background: linear-gradient(to bottom, #ffe8e8, #e0b0b0); }
  .pill-logged { background: linear-gradient(to bottom, #e8f0ff, #b0c4e0); }
  .pill-warning { background: linear-gradient(to bottom, #fff8e8, #e0d0b0); }
  .content-grid { display: grid; grid-template-columns: 280px 1fr; gap: 10px; }
  .panel {
    border: 1px solid #ffffff; box-shadow: 0 0 0 1px #808080 inset;
    background: #dcdcdc; padding: 8px; font-size: 12px;
  }
  .panel-title {
    font-weight: bold; margin-bottom: 6px; padding-bottom: 3px;
    border-bottom: 1px solid #b0b0b0;
  }
  .field-group { margin-bottom: 8px; }
  .field-label { display: block; font-size: 11px; margin-bottom: 3px; }
  input[type="text"], input[type="password"] {
    width: 100%; padding: 4px 5px; border: 1px solid #808080;
    background: #ffffff; font-size: 12px;
  }
  button {
    padding: 4px 12px; font-size: 12px;
    border: 1px solid #404040; background: linear-gradient(to bottom, #f8f8f8, #c0c0c0);
    cursor: pointer; border-radius: 3px;
  }
  button:hover { background: linear-gradient(to bottom, #ffffff, #e0e0e0); }
  button:active { background: linear-gradient(to bottom, #c0c0c0, #f8f8f8); }
  button[disabled] { opacity: 0.55; cursor: default; }
  .btn-primary {
    background: linear-gradient(to bottom, #d0e4ff, #a0c8ff);
    border-color: #0a246a;
  }
  .btn-danger {
    background: linear-gradient(to bottom, #ffe0e0, #ffb0b0);
    border-color: #800000;
  }
  .btn-success {
    background: linear-gradient(to bottom, #e0ffe0, #a0e0a0);
    border-color: #0a7c00;
  }
  .btn-warning {
    background: linear-gradient(to bottom, #fff0e0, #ffd0b0);
    border-color: #c0a000;
  }
  .mini-note { font-size: 10px; color: #444; margin-top: 4px; }
  .quiz-questions { margin: 8px 0; }
  .quiz-question {
    margin-bottom: 12px; padding: 8px; border-radius: 3px;
    background: #f8f8f8; border: 1px solid #b0b0b0;
    position: relative;
  }
  .quiz-question strong { color: #0a246a; }
  .quiz-input input { margin-top: 4px; }
  .info-line { font-size: 11px; margin: 6px 0; line-height: 1.4; }
  .reward-info-box {
    margin-top: 8px; padding: 6px; border-radius: 3px;
    background: #fffbe8; border: 1px solid #c0a000; font-size: 11px;
  }
  .cashout-item {
    margin: 8px 0; padding: 8px; border-radius: 3px;
    background: #f0f8ff; border: 1px solid #4a90e2;
  }
  .cashout-item strong { color: #0a246a; }
  .cashout-item button { margin-top: 6px; }
  .footer-bar {
    margin-top: 10px; font-size: 10px; text-align: right; color: #444;
  }
  .hidden { display: none !important; }
  
  /* Anti-Cheat Styles */
  .cheat-check {
    background: #fffaf0;
    border: 1px solid #ffcc00;
    border-left: 4px solid #ff9900;
    padding: 8px;
    margin-top: 8px;
    position: relative;
  }
  .cheat-check::before {
    content: 'ğŸ”’ ANTI-CHEAT';
    position: absolute;
    top: -8px;
    left: 10px;
    background: #ff9900;
    color: white;
    font-size: 9px;
    padding: 1px 6px;
    border-radius: 2px;
    font-weight: bold;
  }
  .last-char-instruction {
    font-size: 11px;
    color: #800000;
    margin-bottom: 8px;
    padding: 4px;
    background: #fff0f0;
    border: 1px dashed #ff6666;
    text-align: center;
  }
  .char-input-container {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
  }
  .char-input-label {
    font-size: 11px;
    font-weight: bold;
    color: #333;
    white-space: nowrap;
  }
  .char-input {
    padding: 4px;
    border: 1px solid #808080;
    background: white;
    text-align: center;
    font-size: 11px;
    font-weight: bold;
    width: 40px;
  }
  .char-input:focus {
    border-color: #0a246a;
    outline: none;
    background: #f0f8ff;
  }
  
  /* Toast */
  .toast {
    position: fixed; bottom: 16px; left: 16px;
    background: var(--danger); color: white;
    padding: 10px 14px; border-radius: 4px; font-size: 12px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.5);
    opacity: 0; pointer-events: none;
    transform: translateY(12px);
    transition: all 0.25s ease;
    z-index: 9999;
    max-width: 320px;
    border: 1px solid #ffffff;
    border-left: 4px solid #ff0000;
  }
  .toast.success { 
    background: var(--success); 
    border-left: 4px solid #00aa00;
  }
  .toast.warning { 
    background: var(--warning); 
    border-left: 4px solid #ff9900;
  }
  .toast.show {
    opacity: 1; transform: translateY(0); pointer-events: auto;
  }
  
  @media (max-width: 720px) {
    .app-shell { margin: 8px; }
    .content-grid { grid-template-columns: 1fr; }
    .hamburger { display: flex; }
    .left-panel-collapsed .left-panel { display: none; }
    .toast { left: 50%; right: auto; transform: translateX(-50%) translateY(12px); }
    .toast.show { transform: translateX(-50%) translateY(0); }
    .char-input-container { flex-direction: column; align-items: flex-start; }
    .char-input { width: 100%; }
  }
</style>
</head>
<body>
<div class="app-shell" id="appShell">
  <div class="title-bar">
    <div class="title-left">
      <div class="logo-box"></div>
      <div class="title-text">IML Quiz Rewards Console</div>
    </div>
    <div class="title-right">
      <div id="titleUser">Guest</div>
      <div id="titleUserLogo" class="user-logo"></div>
      <div class="hamburger" id="hamburger">
        <span></span><span></span><span></span>
      </div>
    </div>
  </div>

  <div class="window-body">
    <div class="top-status-bar">
      <div class="status-group">
        <span class="status-label">Session:</span>
        <span id="loginStatus" class="pill pill-logged">Logged out</span>
        <button id="logoutBtn" class="btn-danger" style="display:none;">Logout</button>
        <button id="loginTopBtn" class="btn-primary">Login</button>
      </div>
      <div class="status-group">
        <span class="status-label">Balance:</span>
        <span id="balancePill" class="pill pill-balance">0.0 pts</span>
        <span class="status-label">Reversal:</span>
        <span id="reversalPill" class="pill pill-reversal">0.0 %</span>
        <span class="pill pill-warning" id="cheatStatus" style="display:none;">ğŸ”’ Last Char Check</span>
      </div>
    </div>

    <div class="content-grid">
      <!-- Left Panel -->
      <div class="panel left-panel">
        <div class="panel-title" id="leftPanelTitle">Account Login</div>
        
        <div id="loginPanel">
          <div class="field-group">
            <label class="field-label" for="userIdInput">UserID</label>
            <input type="text" id="userIdInput" placeholder="Enter User ID" autocomplete="off" />
          </div>
          <div class="field-group">
            <label class="field-label" for="passIdInput">Password</label>
            <input type="password" id="passIdInput" placeholder="Enter Password" autocomplete="off" />
          </div>
          <div style="display:flex; gap:8px; margin:10px 0;">
            <button id="loginBtn" class="btn-primary">Login</button>
            <button id="signupBtn" class="btn-success">Sign Up</button>
          </div>
        </div>

        <div id="quizIdPanel" class="hidden">
          <div class="field-group">
            <label class="field-label" for="quizIdInput">Quiz Access ID</label>
            <input type="text" id="quizIdInput" placeholder="Enter Quiz ID" autocomplete="off" />
          </div>
          <button id="loadQuizBtn" class="btn-primary">Load Quiz</button>
          <div class="mini-note">Questions loaded from Google Sheet</div>
          <div class="mini-note" style="color:#b00000; margin-top:6px;">
            <strong>âš  Anti-Cheat Active:</strong> Must enter last character of each question
          </div>
        </div>
        
        <div id="userActions" class="hidden" style="margin-top:12px;">
          <div class="panel-title">Quick Actions</div>
          <div style="display:flex; flex-direction:column; gap:6px; margin-top:8px;">
            <button id="redeemBtn" class="btn-warning">Redeem Code</button>
            <button id="cashoutBtn" class="btn-success">View Cashout</button>
            <button id="historyBtn" class="btn-primary">History</button>
          </div>
        </div>
      </div>

      <!-- Right Panel -->
      <div class="panel">
        <div class="panel-title" id="rightPanelTitle">Welcome to IML Quiz Rewards</div>

        <!-- Welcome Message (shown when not logged in) -->
        <div id="welcomePanel">
          <div class="info-line" style="margin: 15px 0;">
            <p><strong>Welcome to IML Quiz Rewards System!</strong></p>
            <p>Please login or sign up to:</p>
            <ul style="margin: 8px 0 8px 20px; font-size: 11px;">
              <li>Take quizzes and earn points</li>
              <li>Redeem bonus codes</li>
              <li>Cashout rewards</li>
              <li>Track your progress</li>
            </ul>
            <p style="margin-top: 10px; font-size: 10px; color: #444;">
              <strong>Note:</strong> Anti-cheat system is active. Must enter last character of each question.
            </p>
          </div>
        </div>

        <div id="quizPanel" class="hidden">
          <div id="quizMeta" class="info-line"></div>
          <div class="quiz-questions" id="quizQuestions"></div>
          <button id="submitQuizBtn" class="btn-primary" disabled>Submit Answers</button>
          <div id="quizResult" class="info-line"></div>
        </div>

        <div id="redeemPanel" class="hidden" style="margin-top:12px;">
          <div class="panel-title">Redeem Bonus Code</div>
          <div class="field-group">
            <label class="field-label">Bonus Code</label>
            <input type="text" id="bonusCodeInput" placeholder="e.g. WELCOME250" />
            <div class="mini-note" id="redeemNote">Enter valid bonus code</div>
          </div>
          <button id="redeemCodeBtn" class="btn-warning">Redeem Code</button>
          <div id="redeemResult" class="info-line" style="margin-top:8px;"></div>
        </div>

        <div id="cashoutPanel" class="hidden" style="margin-top:12px;">
          <div class="panel-title">Cashout Options</div>
          <div id="cashoutOptions" class="info-line">Cashout options will appear when you accumulate enough points</div>
          <div id="cashoutResult" class="info-line" style="margin-top:8px;"></div>
        </div>

        <div id="historyPanel" class="hidden" style="margin-top:12px;">
          <div class="panel-title">Activity History</div>
          <div id="historyContent" class="info-line">Your activity history will appear here.</div>
        </div>
      </div>
    </div>

    <div class="footer-bar">
      Reversal % = (1 âˆ’ (Earned / Total possible)) Ã— 100 â€¢ Anti-Cheat: Must enter last character (letter/number/symbol) of each question
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
// CONFIG
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbziffUlLgUP8jbifYKkXxHcw47VIbaYUC28JfG8L62cffMeVEZkIda5oSmup2hjibhc/exec";

// State
let currentUser = null;
let currentQuiz = null;
let userBalance = 0;
let userReversal = 0;
let lastCharacters = {};

// DOM cache
const $ = id => document.getElementById(id);
const els = {
  // Core elements
  appShell: $("appShell"),
  toast: $("toast"),
  
  // Navigation
  hamburger: $("hamburger"),
  titleUser: $("titleUser"),
  loginStatus: $("loginStatus"),
  balancePill: $("balancePill"),
  reversalPill: $("reversalPill"),
  cheatStatus: $("cheatStatus"),
  loginTopBtn: $("loginTopBtn"),
  
  // Panel Titles
  leftPanelTitle: $("leftPanelTitle"),
  rightPanelTitle: $("rightPanelTitle"),
  
  // Login
  loginBtn: $("loginBtn"),
  signupBtn: $("signupBtn"),
  logoutBtn: $("logoutBtn"),
  userIdInput: $("userIdInput"),
  passIdInput: $("passIdInput"),
  
  // Panels
  loginPanel: $("loginPanel"),
  welcomePanel: $("welcomePanel"),
  quizIdPanel: $("quizIdPanel"),
  userActions: $("userActions"),
  quizPanel: $("quizPanel"),
  redeemPanel: $("redeemPanel"),
  cashoutPanel: $("cashoutPanel"),
  historyPanel: $("historyPanel"),
  
  // Quiz
  quizIdInput: $("quizIdInput"),
  loadQuizBtn: $("loadQuizBtn"),
  quizMeta: $("quizMeta"),
  quizQuestions: $("quizQuestions"),
  submitQuizBtn: $("submitQuizBtn"),
  quizResult: $("quizResult"),
  
  // Redeem
  bonusCodeInput: $("bonusCodeInput"),
  redeemCodeBtn: $("redeemCodeBtn"),
  redeemNote: $("redeemNote"),
  redeemResult: $("redeemResult"),
  
  // Cashout
  cashoutOptions: $("cashoutOptions"),
  cashoutResult: $("cashoutResult"),
  
  // History
  historyContent: $("historyContent"),
  
  // Quick Actions
  redeemBtn: $("redeemBtn"),
  cashoutBtn: $("cashoutBtn"),
  historyBtn: $("historyBtn")
};

// Toast helper
function showToast(msg, type = "error", ms = 3200) {
  els.toast.textContent = msg;
  els.toast.className = `toast ${type} show`;
  setTimeout(() => els.toast.classList.remove("show"), ms);
}

// API call function
async function apiCall(action, data = {}) {
  if (!action) {
    showToast("Client bug: no action", "error", 5000);
    return { success: false, error: "missing action" };
  }

  try {
    const params = { action, ...data };
    const bodyParts = [];
    for (const key in params) {
      bodyParts.push(encodeURIComponent(key) + '=' + encodeURIComponent(params[key]));
    }
    const bodyString = bodyParts.join('&');
    
    const response = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: bodyString,
      redirect: 'follow'
    });
    
    const text = await response.text();
    
    try {
      const result = JSON.parse(text);
      return result;
    } catch (parseErr) {
      console.error('JSON parse error:', parseErr, 'Text:', text);
      showToast('Server response error', 'error', 5000);
      return { success: false, error: 'Invalid server response' };
    }
    
  } catch (err) {
    console.error(`${action} failed:`, err);
    showToast(`Connection failed: ${err.message}`, "error", 6000);
    return { success: false, error: err.message };
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SESSION MANAGEMENT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initSession() {
  const savedUser = localStorage.getItem('quizUser');
  if (savedUser) {
    const userData = JSON.parse(savedUser);
    currentUser = userData.userId;
    userBalance = userData.balance || 0;
    userReversal = userData.reversal || 0;
    
    updateUserDisplay(userData.userId, userData.balance, userReversal);
    showLoggedInView();
    restoreSession(userData.userId);
  } else {
    showLoggedOutView();
  }
}

function saveSession(userId, balance, reversal) {
  const userData = {
    userId: userId,
    balance: balance,
    reversal: reversal,
    timestamp: Date.now()
  };
  localStorage.setItem('quizUser', JSON.stringify(userData));
}

function clearSession() {
  localStorage.removeItem('quizUser');
  currentUser = null;
  userBalance = 0;
  userReversal = 0;
  lastCharacters = {};
  
  updateUserDisplay('Guest', 0, 0);
  showLoggedOutView();
  showToast('Logged out successfully', 'success');
}

async function restoreSession(userId) {
  const response = await apiCall('restoreSession', { userId: userId });
  if (response.success) {
    userBalance = response.user.balance;
    userReversal = response.user.reversal;
    updateUserDisplay(userId, userBalance, userReversal);
  } else {
    clearSession();
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// USER INTERFACE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateUserDisplay(username, balance, reversal) {
  els.titleUser.textContent = username || 'Guest';
  els.loginStatus.textContent = username ? 'Logged in' : 'Logged out';
  els.balancePill.textContent = Number(balance).toFixed(1) + " pts";
  els.reversalPill.textContent = Number(reversal).toFixed(1) + " %";
  
  if (username) {
    els.loginTopBtn.style.display = 'none';
    els.logoutBtn.style.display = 'inline-block';
  } else {
    els.loginTopBtn.style.display = 'inline-block';
    els.logoutBtn.style.display = 'none';
  }
}

function showLoggedOutView() {
  // Left panel
  els.leftPanelTitle.textContent = "Account Login";
  els.loginPanel.classList.remove('hidden');
  els.quizIdPanel.classList.add('hidden');
  els.userActions.classList.add('hidden');
  
  // Right panel
  els.rightPanelTitle.textContent = "Welcome to IML Quiz Rewards";
  els.welcomePanel.classList.remove('hidden');
  els.quizPanel.classList.add('hidden');
  els.redeemPanel.classList.add('hidden');
  els.cashoutPanel.classList.add('hidden');
  els.historyPanel.classList.add('hidden');
  
  // Hide cheat status
  els.cheatStatus.style.display = 'none';
}

function showLoggedInView() {
  // Left panel
  els.leftPanelTitle.textContent = "Quiz Access";
  els.loginPanel.classList.add('hidden');
  els.quizIdPanel.classList.remove('hidden');
  els.userActions.classList.remove('hidden');
  
  // Right panel - show quiz panel by default
  els.rightPanelTitle.textContent = "Active Quiz & Reward";
  els.welcomePanel.classList.add('hidden');
  showPanel('quizPanel');
  
  // Update redeem note based on reversal
  if (userReversal > 10) {
    els.redeemNote.innerHTML = '<span style="color:#b00000;">âŒ Cannot redeem: reversal > 10%</span>';
    els.redeemNote.style.display = 'block';
  } else {
    els.redeemNote.innerHTML = 'Enter valid bonus code';
    els.redeemNote.style.display = 'block';
  }
}

function showPanel(panelId) {
  // Hide all panels except welcome (which is already hidden when logged in)
  const panels = ['quizPanel', 'redeemPanel', 'cashoutPanel', 'historyPanel'];
  panels.forEach(panel => els[panel].classList.add('hidden'));
  
  // Show selected panel
  if (els[panelId]) {
    els[panelId].classList.remove('hidden');
  }
  
  // Update right panel title
  const titles = {
    'quizPanel': 'Active Quiz & Reward',
    'redeemPanel': 'Redeem Bonus Code',
    'cashoutPanel': 'Cashout Options',
    'historyPanel': 'Activity History'
  };
  els.rightPanelTitle.textContent = titles[panelId] || 'Active Quiz & Reward';
  
  // Show cheat status for quiz panel
  if (panelId === 'quizPanel') {
    els.cheatStatus.textContent = "ğŸ”’ Last Char Check";
    els.cheatStatus.style.display = 'inline-block';
  } else {
    els.cheatStatus.style.display = 'none';
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// AUTHENTICATION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function handleLogin() {
  const uid = els.userIdInput.value.trim();
  const pwd = els.passIdInput.value.trim();
  if (!uid || !pwd) return showToast("Enter UserID and Password");

  els.loginBtn.disabled = true; 
  els.loginBtn.textContent = "Logging inâ€¦";
  
  const res = await apiCall("login", { userId: uid, password: pwd });
  
  els.loginBtn.disabled = false; 
  els.loginBtn.textContent = "Login";

  if (!res.success) return showToast(res.error || "Login failed");

  currentUser = uid;
  userBalance = res.user.balance;
  userReversal = res.user.reversal;

  saveSession(uid, userBalance, userReversal);
  updateUserDisplay(uid, userBalance, userReversal);
  showLoggedInView();
  showToast("Logged in!", "success");
}

async function handleSignup() {
  const uid = els.userIdInput.value.trim();
  const pwd = els.passIdInput.value.trim();
  if (!uid || !pwd) return showToast("Enter UserID and Password");

  els.signupBtn.disabled = true; 
  els.signupBtn.textContent = "Creatingâ€¦";
  
  const res = await apiCall("signup", { userId: uid, password: pwd });
  
  els.signupBtn.disabled = false; 
  els.signupBtn.textContent = "Sign Up";

  if (!res.success) return showToast(res.error || "Signup failed");

  // Auto-login after signup
  const loginRes = await apiCall("login", { userId: uid, password: pwd });
  if (loginRes.success) {
    currentUser = uid;
    userBalance = loginRes.user.balance;
    userReversal = loginRes.user.reversal;

    saveSession(uid, userBalance, userReversal);
    updateUserDisplay(uid, userBalance, userReversal);
    showLoggedInView();
    showToast("Account created & logged in!", "success", 4000);
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ANTI-CHEAT FUNCTIONS - Last Character System
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getLastCharacter(text) {
  // Get the last non-whitespace character
  const trimmed = text.trim();
  if (trimmed.length === 0) return '';
  return trimmed.charAt(trimmed.length - 1);
}

function checkLastCharacters(questionNum, userChar) {
  const correctChar = lastCharacters[`q${questionNum}`] || '';
  
  // Compare case-sensitive (since it could be a letter, number, or symbol)
  return userChar.trim() === correctChar;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// QUIZ FUNCTIONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadQuiz() {
  const qid = els.quizIdInput.value.trim();
  if (!qid) return showToast("Enter Quiz ID");

  els.loadQuizBtn.disabled = true; 
  els.loadQuizBtn.textContent = "Loadingâ€¦";
  
  const res = await apiCall("getQuiz", { quizId: qid });
  
  els.loadQuizBtn.disabled = false; 
  els.loadQuizBtn.textContent = "Load Quiz";

  if (!res.success) return showToast(res.error || "Quiz not found");

  currentQuiz = res.quiz;
  lastCharacters = {};

  els.quizMeta.textContent = `Reward: ${currentQuiz.rewardName || "?"} â€¢ ${currentQuiz.rewardAmount || 0} pts`;
  els.quizQuestions.innerHTML = "";
  els.submitQuizBtn.disabled = false;
  els.quizResult.innerHTML = "";

  let i = 1;
  while (currentQuiz[`q${i}`]) {
    const txt = currentQuiz[`q${i}`];
    
    // Get last character for anti-cheat
    const lastChar = getLastCharacter(txt);
    lastCharacters[`q${i}`] = lastChar;
    
    const div = document.createElement("div");
    div.className = "quiz-question";
    div.innerHTML = `
      <strong>Q${i}:</strong> ${txt}
      <div class="quiz-input" style="margin-top:6px;">
        <input type="text" id="ans${i}" placeholder="Your answer" autocomplete="off" style="width:100%;">
      </div>
      
      <div class="cheat-check">
        <div class="last-char-instruction">
          ANTI-CHEAT: Enter the last character (letter, number, or symbol) of the question above
        </div>
        <div class="char-input-container">
          <div class="char-input-label">Last Character:</div>
          <input type="text" class="char-input" id="lastchar${i}" placeholder="?" maxlength="1">
        </div>
        <div style="font-size:10px; color:#666; text-align:center; margin-top:4px;">
          Must be exact. If wrong, quiz earns 0 points and reversal increases.
        </div>
      </div>
    `;
    els.quizQuestions.appendChild(div);
    i++;
  }

  showPanel('quizPanel');
  showToast("Quiz loaded with last character verification", "success");
}

async function submitQuiz() {
  if (!currentQuiz) return showToast("No quiz loaded");
  if (!currentUser) return showToast("Please login first");

  els.submitQuizBtn.disabled = true; 
  els.submitQuizBtn.textContent = "Submittingâ€¦";

  // Collect answers and last characters
  const answers = {};
  const lastChars = {};
  let allLastCharsCorrect = true;
  let i = 1;
  
  while ($(`ans${i}`)) {
    // Main answer
    answers[`a${i}`] = $(`ans${i}`).value.trim();
    
    // Last character verification
    const userChar = $(`lastchar${i}`)?.value.trim() || '';
    const isCorrect = checkLastCharacters(i, userChar);
    lastChars[`l${i}`] = isCorrect;
    
    if (!isCorrect) {
      allLastCharsCorrect = false;
    }
    
    i++;
  }

  // If any last character is wrong, prepare for 0 points submission
  if (!allLastCharsCorrect) {
    showToast('ANTI-CHEAT FAILED: One or more last characters are incorrect! Quiz will earn 0 points.', 'error', 5000);
    
    // Continue with submission but flag for server to give 0 points
    // We'll send a flag to indicate last char verification failed
  }

  const res = await apiCall("submitQuiz", {
    userId: currentUser,
    quizId: currentQuiz.quizId || els.quizIdInput.value.trim(),
    answers: JSON.stringify(answers),
    lastChars: JSON.stringify(lastChars), // Send verification results
    lastCharAllCorrect: allLastCharsCorrect // Flag for server
  });

  els.submitQuizBtn.textContent = "Submit Answers";

  if (!res.success) {
    els.submitQuizBtn.disabled = false;
    return showToast(res.error || "Submission failed");
  }

  // Show result
  let resultHtml = '';
  if (!allLastCharsCorrect) {
    resultHtml = `
      <div style="background:#fff0f0; border:1px solid #b00000; padding:8px; border-radius:3px;">
        <strong>âŒ Quiz Failed Anti-Cheat!</strong><br>
        <div style="margin-top:4px;">
          <span style="color:#b00000;">âœ— Last character verification FAILED</span><br>
          Earned: <b>0/${res.totalReward || 250} pts</b><br>
          New reversal: <b>${Number(res.newReversal || 0).toFixed(1)}%</b><br>
          New balance: <b>${Number(res.newBalance || userBalance).toFixed(1)} pts</b><br>
          <div style="margin-top:6px; font-size:10px;">
            One or more last characters were incorrect. Entire quiz earns 0 points.
          </div>
        </div>
      </div>
    `;
  } else {
    resultHtml = `
      <div style="background:#f0fff0; border:1px solid #00aa00; padding:8px; border-radius:3px;">
        <strong>âœ… Quiz Submitted Successfully!</strong><br>
        <div style="margin-top:4px;">
          <span style="color:#00aa00;">âœ“ Last character verification PASSED</span><br>
          Correct: <b>${res.correct || 0}/${res.totalQuestions || 0}</b><br>
          Earned: <b>${Number(res.earned || 0).toFixed(1)}/${res.totalReward || 250} pts</b><br>
          New reversal: <b>${Number(res.newReversal || 0).toFixed(1)}%</b><br>
          New balance: <b>${Number(res.newBalance || 0).toFixed(1)} pts</b>
        </div>
      </div>
    `;
  }

  resultHtml += `
    <div style="margin-top:8px; text-align:center;">
      <button id="backToQuizBtn" class="btn-primary">Take Another Quiz</button>
    </div>
  `;

  els.quizResult.innerHTML = resultHtml;

  // Update user data
  userBalance = parseFloat(res.newBalance || userBalance);
  userReversal = parseFloat(res.newReversal || userReversal);
  saveSession(currentUser, userBalance, userReversal);
  updateUserDisplay(currentUser, userBalance, userReversal);

  // Reset quiz state
  currentQuiz = null;
  lastCharacters = {};
  els.quizIdInput.value = "";
  
  // Add back button listener
  $("#backToQuizBtn").addEventListener("click", () => {
    els.quizResult.innerHTML = "";
    els.submitQuizBtn.disabled = true;
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// REDEEM & CASHOUT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function redeemBonusCode() {
  const code = els.bonusCodeInput.value.trim();
  if (!code) return showToast("Enter bonus code");
  if (!currentUser) return showToast("Please login first");

  // Check reversal restriction
  if (userReversal > 10) {
    showToast("Cannot redeem: reversal rate > 10%", "error");
    return;
  }

  els.redeemCodeBtn.disabled = true; 
  els.redeemCodeBtn.textContent = "Redeemingâ€¦";
  
  const res = await apiCall("redeemCode", { 
    userId: currentUser,
    code: code 
  });
  
  els.redeemCodeBtn.disabled = false; 
  els.redeemCodeBtn.textContent = "Redeem Code";

  if (!res.success) {
    els.redeemResult.innerHTML = `<span style="color:#b00000;">âŒ ${res.error || "Invalid code"}</span>`;
    return showToast(res.error || "Redemption failed", "error");
  }

  // Update balance
  userBalance = parseFloat(res.newBalance);
  saveSession(currentUser, userBalance, userReversal);
  updateUserDisplay(currentUser, userBalance, userReversal);
  
  els.redeemResult.innerHTML = `<span style="color:#0a7c00;">âœ… Success! +${res.amount} pts added</span>`;
  els.bonusCodeInput.value = "";
  showToast(`Bonus code redeemed! +${res.amount} pts`, "success", 4000);
}

async function loadCashoutOptions() {
  const res = await apiCall("getCashoutOptions");
  
  if (!res.success || !res.cashoutOptions || res.cashoutOptions.length === 0) {
    els.cashoutOptions.innerHTML = '<em>No cashout options available at this time</em>';
    return;
  }
  
  // Filter affordable options
  const affordableOptions = res.cashoutOptions.filter(option => 
    parseFloat(option.rewardAmount) <= userBalance
  );
  
  if (affordableOptions.length === 0) {
    els.cashoutOptions.innerHTML = `
      <em>Need more points to cash out</em><br>
      <span style="font-size:10px; color:#444;">Current: ${userBalance.toFixed(1)} pts</span>
    `;
    return;
  }
  
  // Display options
  let html = '';
  affordableOptions.forEach(option => {
    html += `
      <div class="cashout-item">
        <strong>${option.rewardName}</strong><br>
        <span style="font-size:11px;">Cost: ${option.rewardAmount} pts</span><br>
        <span style="font-size:10px; color:#444;">${option.info}</span><br>
        <button class="btn-success cashout-redeem-btn" 
                data-reward="${option.rewardName}" 
                data-cost="${option.rewardAmount}">
          Redeem ${option.rewardAmount} pts
        </button>
      </div>
    `;
  });
  
  els.cashoutOptions.innerHTML = html;
  
  // Add event listeners
  document.querySelectorAll('.cashout-redeem-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      handleCashout(btn.dataset.reward, btn.dataset.cost);
    });
  });
}

async function handleCashout(rewardName, cost) {
  if (!currentUser) return showToast("Please login first");
  
  const needCost = parseFloat(cost);
  if (userBalance < needCost) {
    return showToast(`Need ${needCost} pts â€“ have ${userBalance.toFixed(1)}`);
  }
  
  if (!confirm(`Cashout "${rewardName}" for ${needCost} points?`)) return;
  
  const res = await apiCall("cashout", {
    userId: currentUser,
    rewardName: rewardName
  });
  
  if (!res.success) {
    els.cashoutResult.innerHTML = `<span style="color:#b00000;">âŒ ${res.error}</span>`;
    return showToast(res.error || "Cashout failed", "error");
  }
  
  // Update balance
  userBalance = parseFloat(res.newBalance);
  saveSession(currentUser, userBalance, userReversal);
  updateUserDisplay(currentUser, userBalance, userReversal);
  
  els.cashoutResult.innerHTML = `
    <div style="background:#f0fff0; border:1px solid #00aa00; padding:8px; border-radius:3px;">
      <strong>âœ… Cashout Successful!</strong><br>
      ${res.message || "Reward redeemed successfully"}<br>
      <span style="font-size:10px;">Details: ${res.info || 'Check your email'}</span>
    </div>
  `;
  
  showToast("Cashout successful! " + res.message, "success", 5000);
  
  // Reload cashout options
  setTimeout(loadCashoutOptions, 1000);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// EVENT LISTENERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Login/Signup
els.loginBtn.addEventListener("click", handleLogin);
els.signupBtn.addEventListener("click", handleSignup);
els.logoutBtn.addEventListener("click", clearSession);
els.loginTopBtn.addEventListener("click", () => {
  // Focus on login inputs when top login button is clicked
  els.userIdInput.focus();
});

// Quiz
els.loadQuizBtn.addEventListener("click", loadQuiz);
els.submitQuizBtn.addEventListener("click", submitQuiz);

// Redeem
els.redeemCodeBtn.addEventListener("click", redeemBonusCode);

// Quick Actions
els.redeemBtn.addEventListener("click", () => {
  showPanel('redeemPanel');
  els.bonusCodeInput.value = '';
  els.redeemResult.innerHTML = '';
});

els.cashoutBtn.addEventListener("click", () => {
  showPanel('cashoutPanel');
  els.cashoutResult.innerHTML = '';
  loadCashoutOptions();
});

els.historyBtn.addEventListener("click", () => {
  showPanel('historyPanel');
  els.historyContent.innerHTML = '<em>History feature coming soon...</em>';
});

// Enter key listeners
els.userIdInput.onkeypress = e => { if (e.key === "Enter") handleLogin(); };
els.passIdInput.onkeypress = e => { if (e.key === "Enter") handleLogin(); };
els.quizIdInput.onkeypress = e => { if (e.key === "Enter") loadQuiz(); };
els.bonusCodeInput.onkeypress = e => { if (e.key === "Enter") redeemBonusCode(); };

// Hamburger menu for mobile
els.hamburger.addEventListener("click", () => {
  els.appShell.classList.toggle("left-panel-collapsed");
});

// Initialize
initSession();
</script>
</body>
</html>
