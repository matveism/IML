<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>IML Terminal</title>

<style>
html,body{
  margin:0;height:100%;
  background:#1a1a1a;
  font-family:Tahoma;
  color:#0f0;
}
#device{
  width:480px;height:800px;margin:auto;
  background:linear-gradient(#3c3c3c,#0f0f0f);
  border:3px solid #777;
}
#header{
  height:70px;
  background:linear-gradient(#666,#222);
  display:flex;
  align-items:center;
  padding:10px;
}
#icon{
  width:40px;height:40px;
  background:linear-gradient(#0ff,#046);
  border-radius:6px;
  margin-right:10px;
}
#title{font-size:28px;font-weight:bold;color:#fff;}
#content{padding:20px;}

input,button{
  width:100%;
  padding:10px;
  font-size:18px;
  margin-top:10px;
}
input{
  background:#000;
  color:#0f0;
  border:2px inset #555;
}
button{
  background:linear-gradient(#4caf50,#2e7d32);
  border:none;
  color:#fff;
  cursor:pointer;
}
.panel{
  margin-top:15px;
  padding:10px;
  background:#000;
  border:2px inset #555;
}
.hidden{display:none;}
</style>
</head>

<body>
<div id="device">
  <div id="header">
    <div id="icon"></div>
    <div id="title">IML TERMINAL</div>
  </div>

  <div id="content">
    <div id="loginBox">
      <input id="uid" placeholder="UserID">
      <input id="pid" placeholder="PassID" type="password">
      <button onclick="login()">LOGIN</button>
    </div>

    <div id="infoBox" class="panel hidden">
      Status: <span id="status"></span><br>
      PTS: <span id="pts"></span><br>
      Reversal Rate: <span id="rate"></span>
    </div>

    <div id="quizBox" class="panel hidden">
      <div id="question"></div>
      <input id="answer" placeholder="Your answer">
      <button onclick="submitQuiz()">SUBMIT</button>
    </div>
  </div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwC-ZLvf0u5sC50xSFJlt0hZqO3jN7MCCNtX3ewuA0QynuG6Ld-qsk54DLBvmLqtKlk/exec";

let currentUser = null;
let correctAnswer = "";

function parseCSV(text){
  return text.trim().split(/\r?\n/).map(r=>r.split(","));
}

async function login(){
  try{
    const res = await fetch(WEB_APP_URL);
    const csv = await res.text();
    const rows = parseCSV(csv);
    rows.shift();

    const uid = document.getElementById("uid").value.trim();
    const pid = document.getElementById("pid").value.trim();

    currentUser = rows.find(r => r[0]===uid && r[1]===pid);
    if(!currentUser){ alert("LOGIN FAILED"); return; }
    if(currentUser[2]==="BLOCKED"){ alert("ACCOUNT BLOCKED"); return; }

    document.getElementById("status").textContent = currentUser[2];
    document.getElementById("pts").textContent = currentUser[3];
    document.getElementById("rate").textContent = currentUser[4]+"%";
    document.getElementById("question").textContent = currentUser[5];
    correctAnswer = currentUser[6];

    document.getElementById("loginBox").classList.add("hidden");
    document.getElementById("infoBox").classList.remove("hidden");
    document.getElementById("quizBox").classList.remove("hidden");
  }catch(e){
    alert("LOGIN ERROR");
    console.error(e);
  }
}

async function submitQuiz(){
  const answer = document.getElementById("answer").value.trim();
  const reversal = answer!==correctAnswer ? 1 : 0;

  const body =
    "uid="+encodeURIComponent(currentUser[0])+
    "&pts=1"+
    "&reversal="+reversal+
    "&answer="+encodeURIComponent(answer);

  try{
    const res = await fetch(WEB_APP_URL,{
      method:"POST",
      headers:{ "Content-Type":"application/x-www-form-urlencoded" },
      body: body
    });

    const json = await res.json();

    document.getElementById("status").textContent = json.status;
    document.getElementById("pts").textContent = json.pts;
    document.getElementById("rate").textContent = json.reversal+"%";

    document.getElementById("quizBox").classList.add("hidden");

    if(json.status==="BLOCKED"){
      alert("BLOCKED: Reversal > 10%");
    }else{
      alert("Quiz submitted");
    }
  }catch(e){
    alert("ERROR submitting quiz");
    console.error(e);
  }
}
</script>
</body>
</html>
