<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quiz Rewards Console</title>
<style>
  :root {
    --xp-bg: #c0c0c0;
    --xp-dark: #808080;
    --xp-light: #f0f0f0;
    --xp-blue: #0a246a;
    --xp-accent: #0078d7;
    --xp-border: #404040;
    --xp-text: #000000;
    --danger: #b00020;
    --success: #0a7c00;
  }
  * { box-sizing: border-box; font-family: "Tahoma", "Segoe UI", sans-serif; }
  body {
    margin: 0;
    background: radial-gradient(circle at top left, #e0e0e0, #a0a0a0);
    color: var(--xp-text);
    min-height: 100vh;
  }
  .app-shell {
    max-width: 960px;
    margin: 20px auto;
    border: 2px solid var(--xp-border);
    background: var(--xp-bg);
    box-shadow: 0 0 0 1px #ffffff inset, 0 0 12px rgba(0,0,0,0.4);
  }
  .title-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: linear-gradient(to right, #0a246a, #3a6ea5);
    color: #ffffff;
    padding: 4px 8px;
    font-size: 12px;
  }
  .title-left { display: flex; align-items: center; gap: 6px; }
  .logo-box {
    width: 18px; height: 18px;
    background: linear-gradient(135deg, #00ffff, #ff00ff);
    border-radius: 3px; border: 1px solid #ffffff;
  }
  .title-text { font-weight: bold; }
  .title-right { display: flex; align-items: center; gap: 8px; font-size: 11px; }
  .user-logo {
    width: 20px; height: 20px; border-radius: 3px;
    border: 1px solid #ffffff; background-size: cover;
    background-position: center; background-color: #444;
  }
  .hamburger { display: none; width: 20px; height: 16px; flex-direction: column; justify-content: space-between; cursor: pointer; }
  .hamburger span { display: block; height: 3px; background: #ffffff; border-radius: 2px; }
  .window-body { padding: 10px; background: linear-gradient(to bottom, #f4f4f4, #c0c0c0); }
  .top-status-bar {
    display: flex; justify-content: space-between; align-items: center;
    background: #d4d4d4; border: 1px solid #ffffff;
    box-shadow: 0 0 0 1px #808080 inset; padding: 4px 8px; font-size: 11px; margin-bottom: 8px;
  }
  .status-group { display: flex; align-items: center; gap: 10px; }
  .status-label { font-weight: bold; }
  .pill {
    padding: 2px 6px; border-radius: 10px; border: 1px solid #808080;
    background: #f8f8f8; min-width: 60px; text-align: center;
  }
  .pill-balance    { background: linear-gradient(to bottom, #e8ffe8, #b0e0b0); }
  .pill-reversal   { background: linear-gradient(to bottom, #ffe8e8, #e0b0b0); }
  .pill-logged     { background: linear-gradient(to bottom, #e8f0ff, #b0c4e0); }
  .content-grid { display: grid; grid-template-columns: 260px 1fr; gap: 10px; }
  .panel {
    border: 1px solid #ffffff; box-shadow: 0 0 0 1px #808080 inset;
    background: #dcdcdc; padding: 8px; font-size: 12px;
  }
  .panel-title {
    font-weight: bold; margin-bottom: 6px; padding-bottom: 3px;
    border-bottom: 1px solid #b0b0b0;
  }
  .field-group { margin-bottom: 6px; }
  .field-label { display: block; font-size: 11px; margin-bottom: 2px; }
  input[type="text"], input[type="password"] {
    width: 100%; padding: 3px 4px; border: 1px solid #808080;
    background: #ffffff; font-size: 12px;
  }
  button {
    padding: 3px 10px; font-size: 12px;
    border: 1px solid #404040; background: linear-gradient(to bottom, #f8f8f8, #c0c0c0);
    cursor: pointer; border-radius: 2px;
  }
  button:hover { background: linear-gradient(to bottom, #ffffff, #e0e0e0); }
  button:active { background: linear-gradient(to bottom, #c0c0c0, #f8f8f8); }
  button[disabled] { opacity: 0.5; cursor: default; }
  .btn-primary {
    background: linear-gradient(to bottom, #ffffff, #d0e4ff);
    border-color: #0a246a;
  }
  .btn-danger {
    background: linear-gradient(to bottom, #ffe0e0, #ffb0b0);
    border-color: #800000;
  }
  .btn-success {
    background: linear-gradient(to bottom, #e0ffe0, #a0e0a0);
    border-color: #0a7c00;
  }
  .mini-note { font-size: 10px; color: #333; margin-top: 4px; }
  .quiz-questions { margin-top: 6px; }
  .quiz-question {
    margin-bottom: 6px; padding: 4px; border-radius: 3px;
    background: #f4f4f4; border: 1px solid #b0b0b0;
  }
  .quiz-question span { font-weight: bold; }
  .quiz-input { margin-top: 3px; }
  .quiz-input input { width: 100%; padding: 3px 4px; font-size: 11px; }
  .info-line { font-size: 11px; margin-top: 4px; }
  .reward-info-box {
    margin-top: 6px; padding: 4px; border-radius: 3px;
    background: #fffbe8; border: 1px solid #c0a000; font-size: 11px;
  }
  .footer-bar {
    margin-top: 8px; font-size: 10px; text-align: right; color: #333;
  }
  .hidden { display: none !important; }
  .toast {
    position: fixed; bottom: 12px; left: 12px;
    background: var(--danger); color: #ffffff;
    padding: 8px 12px; border-radius: 4px; font-size: 11px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    opacity: 0; pointer-events: none;
    transform: translateY(10px);
    transition: opacity 0.2s ease, transform 0.2s ease;
    z-index: 9999;
    max-width: 300px;
  }
  .toast.success { background: var(--success); }
  .toast.show {
    opacity: 1; pointer-events: auto; transform: translateY(0);
  }
  .loading { opacity: 0.7; cursor: wait; }
  @media (max-width: 720px) {
    .app-shell { margin: 5px; }
    .content-grid { grid-template-columns: 1fr; }
    .hamburger { display: flex; }
    .left-panel-collapsed .left-panel { display: none; }
    .toast { left: 50%; transform: translate(-50%, 10px); }
    .toast.show { transform: translate(-50%, 0); }
  }
</style>
</head>
<body>

<div class="app-shell" id="appShell">
  <div class="title-bar">
    <div class="title-left">
      <div class="logo-box"></div>
      <div class="title-text">Quiz Rewards Console</div>
    </div>
    <div class="title-right">
      <div id="titleUser" class="mini-user">Guest</div>
      <div id="titleUserLogo" class="user-logo"></div>
      <div class="hamburger" id="hamburger">
        <span></span><span></span><span></span>
      </div>
    </div>
  </div>

  <div class="window-body">
    <div class="top-status-bar">
      <div class="status-group">
        <span class="status-label">Session:</span>
        <span id="loginStatus" class="pill pill-logged">Logged out</span>
        <button id="logoutBtn" class="btn-danger" style="display:none;">Logout</button>
      </div>
      <div class="status-group">
        <span class="status-label">Balance:</span>
        <span id="balancePill" class="pill pill-balance">0.0 pts</span>
        <span class="status-label">Reversal:</span>
        <span id="reversalPill" class="pill pill-reversal">0.0 %</span>
      </div>
    </div>

    <div class="content-grid">
      <div class="panel left-panel">
        <div class="panel-title">LOGIN | Quiz Access</div>
        <div id="loginPanel">
          <div class="field-group">
            <label class="field-label" for="userIdInput">UserID</label>
            <input type="text" id="userIdInput" placeholder="m123" autocomplete="off" />
          </div>
          <div class="field-group">
            <label class="field-label" for="passIdInput">PassID</label>
            <input type="password" id="passIdInput" placeholder="m123" autocomplete="off" />
          </div>
          <button id="loginBtn" class="btn-primary">Login</button>
          <div class="mini-note">Try m123 / m123 (case-sensitive)</div>
        </div>
        <div id="quizIdPanel" class="hidden">
          <div class="field-group" style="margin-top:8px;">
            <label class="field-label" for="quizIdInput">Quiz Access ID</label>
            <input type="text" id="quizIdInput" placeholder="demo01" autocomplete="off" />
          </div>
          <button id="loadQuizBtn" class="btn-primary">Load Quiz</button>
          <div class="mini-note">Loaded from Google Sheets</div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">Dashboard | Quiz | Reward</div>
        <div id="quizPanel" class="hidden">
          <div id="quizMeta" class="info-line"></div>
          <div class="quiz-questions" id="quizQuestions"></div>
          <button id="submitQuizBtn" class="btn-primary" disabled>Submit Answers</button>
          <div id="quizResult" class="info-line"></div>
        </div>
        <div id="rewardPanel" class="hidden">
          <div class="info-line">
            <strong>Reward:</strong> <span id="rewardNameLabel"></span> |
            <strong>Amount:</strong> <span id="rewardAmountLabel"></span>
          </div>
          <button id="redeemBtn" class="btn-primary">Redeem Reward</button>
          <div id="rewardInfoBox" class="reward-info-box hidden"></div>
        </div>
      </div>
    </div>

    <div class="footer-bar">
      Reversal % = (1 − (Earned / Total)) × 100        Example: 1/3 of 250 = 83.3 pts
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
// ────────────────────────────────────────────────
// SETTINGS - Google Apps Script API URL
// ────────────────────────────────────────────────
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx86cEIbGJACNmsbcRXsImCe0NbNW_09a1yrNnxl2onIWqLn7IryeSuAo4ir-3ylPdqyQ/exec";

// State
let currentUser    = null;
let currentUserId  = null;
let currentQuiz    = null;
let earnedThisQuiz = 0;

// DOM Elements
const toastEl           = document.getElementById("toast");
const loginBtn          = document.getElementById("loginBtn");
const logoutBtn         = document.getElementById("logoutBtn");
const loadQuizBtn       = document.getElementById("loadQuizBtn");
const submitQuizBtn     = document.getElementById("submitQuizBtn");
const redeemBtn         = document.getElementById("redeemBtn");
const loginStatus       = document.getElementById("loginStatus");
const balancePill       = document.getElementById("balancePill");
const reversalPill      = document.getElementById("reversalPill");
const titleUser         = document.getElementById("titleUser");
const titleUserLogo     = document.getElementById("titleUserLogo");
const quizMeta          = document.getElementById("quizMeta");
const quizQuestions     = document.getElementById("quizQuestions");
const quizResult        = document.getElementById("quizResult");
const rewardNameLabel   = document.getElementById("rewardNameLabel");
const rewardAmountLabel = document.getElementById("rewardAmountLabel");
const rewardInfoBox     = document.getElementById("rewardInfoBox");
const loginPanel        = document.getElementById("loginPanel");
const quizIdPanel       = document.getElementById("quizIdPanel");
const quizPanel         = document.getElementById("quizPanel");
const rewardPanel       = document.getElementById("rewardPanel");
const appShell          = document.getElementById("appShell");
const hamburger         = document.getElementById("hamburger");
const userIdInput       = document.getElementById("userIdInput");
const passIdInput       = document.getElementById("passIdInput");
const quizIdInput       = document.getElementById("quizIdInput");

// Toast notification
function showToast(msg, type = "error", duration = 3000) {
  toastEl.textContent = msg;
  toastEl.className = `toast ${type}`;
  toastEl.classList.add("show");
  setTimeout(() => toastEl.classList.remove("show"), duration);
}

// Google Apps Script API helper
async function apiRequest(action, data = {}) {
  const url = APPS_SCRIPT_URL;
  const params = new URLSearchParams();
  params.append('action', action);
  
  // Add data to params
  Object.keys(data).forEach(key => {
    params.append(key, data[key]);
  });
  
  try {
    console.log(`API Request: ${action}`, data);
    
    // For Google Apps Script, we need to use a specific approach
    const response = await fetch(url, {
      method: 'POST',
      mode: 'no-cors', // Important for Google Apps Script web apps
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: params.toString()
    });
    
    // Since we're using no-cors, we can't read the response directly
    // We'll use a different approach - load the response in an iframe
    return await apiRequestWithIframe(action, data);
    
  } catch (err) {
    console.error("API request failed:", err);
    throw new Error(`Network error: ${err.message}`);
  }
}

// Alternative method using iframe for Google Apps Script
async function apiRequestWithIframe(action, data = {}) {
  return new Promise((resolve, reject) => {
    // Create a unique callback name
    const callbackName = 'callback_' + Date.now() + '_' + Math.random().toString(36).substr(2);
    
    // Create a form
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = APPS_SCRIPT_URL;
    form.target = callbackName;
    form.style.display = 'none';
    
    // Add action parameter
    const actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'action';
    actionInput.value = action;
    form.appendChild(actionInput);
    
    // Add other data parameters
    Object.keys(data).forEach(key => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = key;
      input.value = data[key];
      form.appendChild(input);
    });
    
    // Create iframe for response
    const iframe = document.createElement('iframe');
    iframe.name = callbackName;
    iframe.style.display = 'none';
    
    // Handle response
    iframe.onload = function() {
      try {
        // Try to get the response from iframe
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        const responseText = iframeDoc.body.textContent || iframeDoc.body.innerText;
        
        console.log("Raw response:", responseText);
        
        let response;
        try {
          response = JSON.parse(responseText);
        } catch (e) {
          // If not JSON, try to parse as plain text
          response = { success: false, error: "Invalid response format", raw: responseText };
        }
        
        // Clean up
        setTimeout(() => {
          document.body.removeChild(form);
          document.body.removeChild(iframe);
        }, 100);
        
        if (response.success === false) {
          reject(new Error(response.error || "Request failed"));
        } else {
          resolve(response);
        }
      } catch (err) {
        reject(err);
      }
    };
    
    // Add to document and submit
    document.body.appendChild(form);
    document.body.appendChild(iframe);
    form.submit();
  });
}

// Direct fetch with query parameters (alternative method)
async function directApiRequest(action, data = {}) {
  const url = new URL(APPS_SCRIPT_URL);
  url.searchParams.append('action', action);
  
  Object.keys(data).forEach(key => {
    url.searchParams.append(key, data[key]);
  });
  
  try {
    console.log("Direct request to:", url.toString());
    
    // Try with fetch and cors mode
    const response = await fetch(url.toString(), {
      method: 'GET',
      mode: 'cors',
      redirect: 'follow'
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const text = await response.text();
    console.log("Response text:", text);
    
    try {
      return JSON.parse(text);
    } catch (e) {
      return { success: true, data: text };
    }
  } catch (err) {
    console.error("Direct request failed:", err);
    // Fallback to iframe method
    return apiRequestWithIframe(action, data);
  }
}

// Login function
async function login() {
  const userId = userIdInput.value.trim();
  const passId = passIdInput.value.trim();

  if (!userId || !passId) {
    showToast("Enter UserID and PassID");
    return;
  }

  loginBtn.disabled = true;
  loginBtn.textContent = "Logging in...";
  loginBtn.classList.add('loading');

  try {
    const result = await directApiRequest('login', { userId, passId });
    
    if (result.success && result.user) {
      const u = result.user;
      currentUser = u.userId;
      currentUserId = u.id || u.userId;
      
      // Update UI
      titleUser.textContent = currentUser;
      if (u.logoUrl) {
        titleUserLogo.style.backgroundImage = `url(${u.logoUrl})`;
      }
      
      loginStatus.textContent = "Logged in";
      loginStatus.classList.add("pill-logged");
      loginPanel.classList.add("hidden");
      quizIdPanel.classList.remove("hidden");
      logoutBtn.style.display = "inline-block";
      
      // Update balance and reversal
      updateUIFromUser(u);
      showToast("Logged in successfully!", "success", 1800);
      
      // Auto-focus quiz ID input
      setTimeout(() => quizIdInput.focus(), 100);
    } else {
      showToast(result.error || "Wrong credentials");
    }
  } catch (err) {
    console.error("Login failed:", err);
    showToast("Login failed: " + err.message, "error", 5000);
  } finally {
    loginBtn.disabled = false;
    loginBtn.textContent = "Login";
    loginBtn.classList.remove('loading');
  }
}

function updateUIFromUser(user) {
  const bal = Number(user.balance || 0);
  const rev = Number(user.reversal || 0);
  balancePill.textContent = bal.toFixed(1) + " pts";
  reversalPill.textContent = rev.toFixed(1) + " %";
}

// Logout function
function logout() {
  currentUser = currentUserId = currentQuiz = null;
  earnedThisQuiz = 0;
  
  // Reset UI
  titleUser.textContent = "Guest";
  titleUserLogo.style.backgroundImage = "none";
  balancePill.textContent = "0.0 pts";
  reversalPill.textContent = "0.0 %";
  loginStatus.textContent = "Logged out";
  loginPanel.classList.remove("hidden");
  quizIdPanel.classList.add("hidden");
  quizPanel.classList.add("hidden");
  rewardPanel.classList.add("hidden");
  logoutBtn.style.display = "none";
  quizQuestions.innerHTML = "";
  quizResult.textContent = "";
  rewardInfoBox.classList.add("hidden");
  
  // Clear inputs
  userIdInput.value = "";
  passIdInput.value = "";
  quizIdInput.value = "";
  
  showToast("Logged out", "success", 1800);
}

// Load quiz function
async function loadQuiz() {
  const quizId = quizIdInput.value.trim();
  if (!quizId) {
    showToast("Enter Quiz Access ID");
    return;
  }

  loadQuizBtn.disabled = true;
  loadQuizBtn.textContent = "Loading...";
  loadQuizBtn.classList.add('loading');

  try {
    const result = await directApiRequest('getQuiz', { quizId });
    
    if (result.success && result.quiz) {
      currentQuiz = result.quiz;
      
      // Update quiz metadata
      quizMeta.textContent = `Reward: ${currentQuiz.rewardName || "—"} | Total: ${currentQuiz.rewardAmount || 0} pts`;
      
      // Clear previous questions
      quizQuestions.innerHTML = "";
      submitQuizBtn.disabled = false;
      
      // Create question inputs
      const questions = [
        { label: "Q1", text: currentQuiz.q1, id: "userQ1", answer: currentQuiz.a1 },
        { label: "Q2", text: currentQuiz.q2, id: "userQ2", answer: currentQuiz.a2 },
        { label: "Q3", text: currentQuiz.q3, id: "userQ3", answer: currentQuiz.a3 }
      ];
      
      questions.forEach(q => {
        if (!q.text) return;
        
        const div = document.createElement("div");
        div.className = "quiz-question";
        div.innerHTML = `
          <div><span>${q.label}:</span> ${q.text}</div>
          <div class="quiz-input">
            <input type="text" id="${q.id}" placeholder="Your answer" autocomplete="off" />
            <div class="mini-note" style="margin-top:2px;">Expected answer: ${q.answer || "Not set"}</div>
          </div>
        `;
        quizQuestions.appendChild(div);
      });
      
      // Update reward info
      rewardNameLabel.textContent = currentQuiz.rewardName || "—";
      rewardAmountLabel.textContent = Number(currentQuiz.rewardAmount || 0).toFixed(1) + " pts";
      rewardInfoBox.textContent = currentQuiz.rewardInfo || "";
      rewardInfoBox.classList.add("hidden");
      
      // Show panels
      quizPanel.classList.remove("hidden");
      rewardPanel.classList.remove("hidden");
      
      showToast("Quiz loaded successfully!", "success", 1800);
      
      // Auto-focus first question input
      setTimeout(() => {
        const firstInput = document.getElementById("userQ1");
        if (firstInput) firstInput.focus();
      }, 100);
    } else {
      showToast(result.error || "Quiz not found");
    }
  } catch (err) {
    console.error("Load quiz error:", err);
    showToast("Failed to load quiz: " + err.message, "error", 4000);
  } finally {
    loadQuizBtn.disabled = false;
    loadQuizBtn.textContent = "Load Quiz";
    loadQuizBtn.classList.remove('loading');
  }
}

// Grade quiz function
async function gradeQuiz() {
  if (!currentQuiz || !currentUser) return;
  
  // Disable submit button during processing
  submitQuizBtn.disabled = true;
  submitQuizBtn.textContent = "Grading...";
  submitQuizBtn.classList.add('loading');
  
  try {
    // Collect user answers
    const answers = {
      q1: document.getElementById("userQ1")?.value.trim() || "",
      q2: document.getElementById("userQ2")?.value.trim() || "",
      q3: document.getElementById("userQ3")?.value.trim() || ""
    };
    
    // Send to API for grading
    const result = await directApiRequest('submitQuiz', {
      userId: currentUserId,
      quizId: currentQuiz.quizId || quizIdInput.value.trim(),
      answers: JSON.stringify(answers)
    });
    
    if (result.success) {
      // Update local state with results
      earnedThisQuiz = Number(result.earned || 0);
      const correct = Number(result.correct || 0);
      const totalQ = Number(result.totalQuestions || 3);
      const total = Number(currentQuiz.rewardAmount || 0);
      
      // Display results
      quizResult.innerHTML = `
        <strong>Results:</strong><br>
        Correct: ${correct}/${totalQ}<br>
        Earned: ${earnedThisQuiz.toFixed(1)} pts<br>
        Total possible: ${total.toFixed(1)} pts
      `;
      
      // Update balance and reversal
      const oldBal = Number(balancePill.textContent) || 0;
      const newBal = oldBal + earnedThisQuiz;
      const newRev = total > 0 ? (1 - (earnedThisQuiz / total)) * 100 : 0;
      
      balancePill.textContent = newBal.toFixed(1) + " pts";
      reversalPill.textContent = newRev.toFixed(1) + " %";
      
      // Save updated user data
      await saveUserProgress(newBal, newRev);
      
      showToast(`Quiz submitted! Earned ${earnedThisQuiz.toFixed(1)} points`, "success", 3000);
    } else {
      showToast(result.error || "Failed to grade quiz");
    }
  } catch (err) {
    console.error("Grade quiz error:", err);
    showToast("Failed to submit quiz: " + err.message, "error", 4000);
  } finally {
    submitQuizBtn.disabled = false;
    submitQuizBtn.textContent = "Submit Answers";
    submitQuizBtn.classList.remove('loading');
  }
}

// Save user progress function
async function saveUserProgress(newBalance, newReversal) {
  if (!currentUserId) return;
  
  try {
    await directApiRequest('updateUser', {
      userId: currentUserId,
      balance: newBalance,
      reversal: newReversal
    });
    
    console.log("Progress saved successfully");
  } catch (err) {
    console.error("Save failed:", err);
    showToast("Could not save progress - check console", "error", 4000);
  }
}

// Redeem reward function
async function handleRedeem() {
  if (!currentQuiz || !currentUserId) {
    showToast("No quiz loaded or user not logged in");
    return;
  }
  
  const needed = Number(currentQuiz.rewardAmount || 0);
  const have = parseFloat(balancePill.textContent) || 0;
  
  if (have < needed) {
    showToast(`Not enough points! Need ${needed}, have ${have.toFixed(1)}`);
    return;
  }
  
  redeemBtn.disabled = true;
  redeemBtn.textContent = "Processing...";
  redeemBtn.classList.add('loading');
  
  try {
    const result = await directApiRequest('redeemReward', {
      userId: currentUserId,
      quizId: currentQuiz.quizId || quizIdInput.value.trim(),
      rewardName: currentQuiz.rewardName || ""
    });
    
    if (result.success) {
      // Update balance after redemption
      const newBalance = have - needed;
      balancePill.textContent = newBalance.toFixed(1) + " pts";
      
      // Update user data in backend
      await saveUserProgress(newBalance, parseFloat(reversalPill.textContent) || 0);
      
      // Show reward info
      rewardInfoBox.textContent = result.message || `Successfully redeemed: ${currentQuiz.rewardName}`;
      rewardInfoBox.classList.remove("hidden");
      
      showToast("Reward redeemed successfully!", "success", 3000);
    } else {
      showToast(result.error || "Failed to redeem reward");
    }
  } catch (err) {
    console.error("Redeem error:", err);
    showToast("Failed to redeem: " + err.message, "error", 4000);
  } finally {
    redeemBtn.disabled = false;
    redeemBtn.textContent = "Redeem Reward";
    redeemBtn.classList.remove('loading');
  }
}

// Event Listeners
loginBtn.addEventListener("click", login);
logoutBtn.addEventListener("click", logout);
loadQuizBtn.addEventListener("click", loadQuiz);
submitQuizBtn.addEventListener("click", gradeQuiz);
redeemBtn.addEventListener("click", handleRedeem);
hamburger.addEventListener("click", () => appShell.classList.toggle("left-panel-collapsed"));

// Enter key support for inputs
userIdInput.addEventListener("keypress", (e) => {
  if (e.key === "Enter") login();
});
passIdInput.addEventListener("keypress", (e) => {
  if (e.key === "Enter") login();
});
quizIdInput.addEventListener("keypress", (e) => {
  if (e.key === "Enter") loadQuiz();
});

// Add keypress listeners for quiz answer inputs dynamically
document.addEventListener('keypress', function(e) {
  if (e.target && e.target.id && e.target.id.startsWith('userQ') && e.key === 'Enter') {
    gradeQuiz();
  }
});

// Initialize
logout();

// Test API connection on load
window.addEventListener('load', async () => {
  try {
    // Simple ping to check API
    const result = await directApiRequest('ping');
    if (result.success) {
      console.log("API connection successful");
    }
  } catch (err) {
    console.warn("API test failed (this is OK during development):", err);
  }
});
</script>
</body>
</html>
